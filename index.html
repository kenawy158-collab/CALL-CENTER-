<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken | Agent Performance Dashboard</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #D32F2F;
            --primary-dark: #b71c1c;
            --primary-light: #ffcdd2;
            --secondary: #FFC107;
            --success: #388E3C;
            --success-light: #c8e6c9;
            --warning: #F57C00;
            --warning-light: #ffe0b2;
            --danger: #D32F2F;
            --danger-light: #ffcdd2;
            --info: #1976D2;
            --dark: #212121;
            --light: #f8f9fa;
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --border: #e0e0e0;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', Helvetica, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #1e1e2d;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            z-index: 20;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .brand {
            padding: 20px;
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            font-weight: 800;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }

        .brand i {
            margin-right: 10px;
        }

        .brand span {
            color: var(--secondary);
        }

        .nav-menu {
            flex: 1;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 15px;
            cursor: pointer;
            color: rgba(255,255,255,0.6);
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.4);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: white;
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            box-shadow: var(--shadow);
        }

        .page-header h2 {
            font-size: 1.4rem;
            color: var(--text-main);
        }

        .page-header p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            border: 1px solid #ddd;
            color: #555;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .view-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-top: 5px;
        }

        .kpi-change {
            font-size: 0.8rem;
            color: var(--success);
            margin-top: 5px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(211, 47, 47, 0.2);
        }

        /* Table Styles */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 1200px;
        }

        th {
            background: #f8f9fa;
            color: var(--text-muted);
            font-weight: 700;
            text-align: center;
            padding: 12px 8px;
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
            vertical-align: middle;
        }

        tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* Editable Cells */
        .editable-cell {
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .editable-cell:hover {
            background-color: #f0f8ff;
            border: 1px solid #cce7ff;
        }

        .editable-cell.editing {
            background-color: #fff;
            border: 2px solid var(--info);
        }

        .editable-cell input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: inherit;
            font-family: inherit;
            padding: 4px;
        }

        .editable-cell input:focus {
            outline: none;
        }

        /* Performance Indicators */
        .performance-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .performance-high {
            background-color: var(--success);
        }

        .performance-medium {
            background-color: var(--warning);
        }

        .performance-low {
            background-color: var(--danger);
        }

        .answer-rate-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
        }

        .rate-high {
            background: var(--success-light);
            color: var(--success);
        }

        .rate-medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .rate-low {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Achievement Badge */
        .achievement-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
        }

        .achievement-high {
            background: var(--success-light);
            color: var(--success);
        }

        .achievement-medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .achievement-low {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Period Selector */
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .period-option {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .period-option:hover {
            background: #f8f9fa;
        }

        .period-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f9f9f9;
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .upload-area p {
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        /* Version Control */
        .version-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .version-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .version-draft {
            background: var(--warning-light);
            color: var(--warning);
        }

        .version-final {
            background: var(--success-light);
            color: var(--success);
        }

        .version-info {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 200;
            transform: translateY(100px);
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .toast.show {
            transform: translateY(0);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 10;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Training Script Styles */
        .script-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            font-family: 'Georgia', serif;
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
        }

        .script-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 15px;
        }

        .script-section {
            margin-bottom: 25px;
        }

        .script-section h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .script-dialogue {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary);
        }

        .script-agent {
            font-weight: bold;
            color: var(--info);
        }

        .script-customer {
            font-style: italic;
            color: var(--text-muted);
        }

        .script-note {
            background: var(--warning-light);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .sidebar, .top-bar, .toast, .no-print {
                display: none !important;
            }
            
            .main-content {
                margin: 0;
                padding: 0;
            }
            
            .view-container {
                padding: 0;
            }
            
            .script-container {
                box-shadow: none;
                padding: 20px;
            }
            
            .script-dialogue {
                background: white;
                border: 1px solid #ddd;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100vh;
                z-index: 1000;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .period-selector {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <i class="fas fa-drumstick-bite"></i>
                <span>CRISPY CALL CENTER</span>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="AgentDashboard.switchView('performance')">
                    <i class="fas fa-chart-line"></i>
                    Agent Performance
                </div>
                <div class="nav-item" onclick="AgentDashboard.switchView('upsell')">
                    <i class="fas fa-hand-holding-usd"></i>
                    Upsell Tracking
                </div>
                <div class="nav-item" onclick="AgentDashboard.switchView('training')">
                    <i class="fas fa-graduation-cap"></i>
                    Training Scripts
                </div>
                <div class="nav-item" onclick="AgentDashboard.switchView('upload')">
                    <i class="fas fa-upload"></i>
                    Upload Data
                </div>
                <div class="nav-item" onclick="AgentDashboard.switchView('analytics')">
                    <i class="fas fa-chart-pie"></i>
                    Analytics
                </div>
                <div class="nav-item" onclick="AgentDashboard.switchView('history')">
                    <i class="fas fa-history"></i>
                    History
                </div>
                <div class="nav-item" onclick="AgentDashboard.switchView('settings')">
                    <i class="fas fa-cog"></i>
                    Settings
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-header">
                    <h2 id="pageTitle">Agent Performance Dashboard</h2>
                    <p id="pageSubtitle">Real-time performance tracking with editable metrics</p>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="AgentDashboard.downloadTemplate()">
                        <i class="fas fa-download"></i> Template
                    </button>
                    <button class="btn btn-primary" onclick="AgentDashboard.openUploadModal()">
                        <i class="fas fa-upload"></i> Upload Excel
                    </button>
                    <button class="btn btn-success" onclick="AgentDashboard.finalizeReport()">
                        <i class="fas fa-check-circle"></i> Finalize Report
                    </button>
                </div>
            </div>

            <!-- View Container -->
            <div class="view-container">
                <!-- Loading Overlay -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                </div>

                <!-- Performance View -->
                <div id="view-performance" class="view active">
                    <!-- Version Control -->
                    <div class="version-control">
                        <div>
                            <span class="version-badge version-draft" id="versionStatus">DRAFT</span>
                            <span class="version-info" id="versionInfo">Last edited by Admin • Just now</span>
                        </div>
                        <div>
                            <span class="version-info" id="periodInfo">Period: 21 Days - Jan 2026</span>
                        </div>
                    </div>

                    <!-- Period Selector -->
                    <div class="period-selector">
                        <div class="period-option active" onclick="AgentDashboard.setPeriod('21-days')">
                            21 Days
                        </div>
                        <div class="period-option" onclick="AgentDashboard.setPeriod('monthly')">
                            Monthly
                        </div>
                        <div class="period-option" onclick="AgentDashboard.setPeriod('custom')">
                            Custom Range
                        </div>
                        <div class="period-option" onclick="AgentDashboard.setPeriod('all')">
                            All Data
                        </div>
                    </div>

                    <!-- KPI Summary -->
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-title">Total Calls</div>
                            <div class="kpi-value" id="kpi-total-calls">15,211</div>
                            <div class="kpi-change">+12.5% from last period</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Answer Rate</div>
                            <div class="kpi-value" id="kpi-answer-rate">42.1%</div>
                            <div class="kpi-change">+3.2% from last period</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Total Sales</div>
                            <div class="kpi-value" id="kpi-total-sales">$124,350</div>
                            <div class="kpi-change">+8.7% from last period</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Top Upseller</div>
                            <div class="kpi-value" id="kpi-top-upseller">Melvin</div>
                            <div class="kpi-title">$2,450 in Upsell Revenue</div>
                        </div>
                    </div>

                    <!-- Add New Agent Form -->
                    <div class="card">
                        <h3>Add New Agent</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label for="newAgentName">Agent Name</label>
                                <input type="text" id="newAgentName" class="form-control" placeholder="Enter agent name">
                            </div>
                            <div class="form-group">
                                <label for="newAgentOrders">Number of Orders</label>
                                <input type="number" id="newAgentOrders" class="form-control" placeholder="Enter number of orders">
                            </div>
                            <div class="form-group">
                                <label for="newAgentSales">Sales Value ($)</label>
                                <input type="number" id="newAgentSales" class="form-control" placeholder="Enter sales value">
                            </div>
                            <div class="form-group">
                                <label for="newAgentTarget">Sales Target ($)</label>
                                <input type="number" id="newAgentTarget" class="form-control" placeholder="Enter sales target">
                            </div>
                            <div class="form-group">
                                <label for="newAgentUpsellAttempts">Upsell Attempts</label>
                                <input type="number" id="newAgentUpsellAttempts" class="form-control" placeholder="Enter upsell attempts">
                            </div>
                            <div class="form-group">
                                <label for="newAgentUpsellSuccess">Successful Upsells</label>
                                <input type="number" id="newAgentUpsellSuccess" class="form-control" placeholder="Enter successful upsells">
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="AgentDashboard.addNewAgent()">
                                <i class="fas fa-plus"></i> Add Agent
                            </button>
                        </div>
                    </div>

                    <!-- Performance Chart -->
                    <div class="card">
                        <h3>Performance Overview</h3>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <!-- Performance Table -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>Agent Performance Details</h3>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-secondary" onclick="AgentDashboard.resetChanges()">
                                    <i class="fas fa-undo"></i> Reset Changes
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="AgentDashboard.saveChanges()">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="agentTable">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Total Rings</th>
                                        <th>Answered</th>
                                        <th>Missed</th>
                                        <th>Avg Wait</th>
                                        <th>Max Wait</th>
                                        <th>Avg Talk</th>
                                        <th>Total Talk</th>
                                        <th>Orders</th>
                                        <th>Sales ($)</th>
                                        <th>Target ($)</th>
                                        <th>Achievement %</th>
                                        <th>Answer Rate</th>
                                        <th>Performance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentTableBody">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                            <i class="fas fa-info-circle"></i> Click on any number to edit. Changes are saved automatically.
                        </div>
                    </div>
                </div>

                <!-- Upsell View -->
                <div id="view-upsell" class="view">
                    <div class="card">
                        <h3>Upsell Performance Tracking</h3>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">
                            Track and analyze upselling performance across all agents. Identify top performers and areas for improvement.
                        </p>
                    </div>

                    <!-- Upsell KPIs -->
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-title">Total Upsell Revenue</div>
                            <div class="kpi-value" id="kpi-upsell-revenue">$8,450</div>
                            <div class="kpi-change">+15.3% from last period</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Avg Upsell Success Rate</div>
                            <div class="kpi-value" id="kpi-upsell-rate">28.5%</div>
                            <div class="kpi-change">+2.1% from last period</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Total Upsell Attempts</div>
                            <div class="kpi-value" id="kpi-upsell-attempts">1,245</div>
                            <div class="kpi-change">+89 from last period</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Top Upseller</div>
                            <div class="kpi-value" id="kpi-upsell-top-agent">Melvin</div>
                            <div class="kpi-title">42% Success Rate</div>
                        </div>
                    </div>

                    <!-- Upsell Chart -->
                    <div class="card">
                        <h3>Upsell Performance Comparison</h3>
                        <div class="chart-container">
                            <canvas id="upsellChart"></canvas>
                        </div>
                    </div>

                    <!-- Upsell Table -->
                    <div class="card">
                        <h3>Agent Upsell Details</h3>
                        <div class="table-wrapper">
                            <table id="upsellTable">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Upsell Attempts</th>
                                        <th>Successful Upsells</th>
                                        <th>Success Rate</th>
                                        <th>Upsell Revenue ($)</th>
                                        <th>Avg Upsell Value ($)</th>
                                        <th>Performance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="upsellTableBody">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Training View -->
                <div id="view-training" class="view">
                    <div class="card no-print">
                        <h3>Training Scripts & Materials</h3>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">
                            Access and print training scripts for agent development and performance improvement.
                        </p>
                        <button class="btn btn-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Script
                        </button>
                    </div>

                    <div class="script-container">
                        <div class="script-header">
                            <h1>Crispy Chicken - Upsell Training Script</h1>
                            <p>Effective Upselling Techniques for Customer Service Excellence</p>
                        </div>

                        <div class="script-section">
                            <h3>1. Opening & Rapport Building</h3>
                            <div class="script-dialogue">
                                <p class="script-agent">Agent: "Thank you for calling Crispy Chicken! My name is [Agent Name]. How can I help you today?"</p>
                                <p class="script-customer">Customer: "I'd like to place an order for delivery."</p>
                                <p class="script-agent">Agent: "Excellent choice! I'd be happy to help you with that. Before we proceed, may I know your name please?"</p>
                            </div>
                            <div class="script-note">
                                <strong>Note:</strong> Always use the customer's name to personalize the conversation and build rapport.
                            </div>
                        </div>

                        <div class="script-section">
                            <h3>2. Order Taking & Opportunity Identification</h3>
                            <div class="script-dialogue">
                                <p class="script-agent">Agent: "Great, [Customer Name]! What would you like to order today?"</p>
                                <p class="script-customer">Customer: "I'll have the crispy chicken burger meal."</p>
                                <p class="script-agent">Agent: "Perfect choice! Our crispy chicken burger is one of our most popular items. Would you like to make it a large meal for just $2 more? You'll get more fries and a larger drink."</p>
                            </div>
                            <div class="script-note">
                                <strong>Note:</strong> Identify upsell opportunities by suggesting size upgrades, add-ons, or complementary items.
                            </div>
                        </div>

                        <div class="script-section">
                            <h3>3. Value Proposition Upsell</h3>
                            <div class="script-dialogue">
                                <p class="script-customer">Customer: "Sure, make it a large meal."</p>
                                <p class="script-agent">Agent: "Excellent! While I have you, our new spicy chicken wings are on special today. Would you like to add a 6-piece order for just $5.99? They pair perfectly with your burger."</p>
                                <p class="script-customer">Customer: "Hmm, I'm not sure."</p>
                                <p class="script-agent">Agent: "I completely understand. Many customers who try them come back specifically for the wings. They're crispy, flavorful, and today's special price saves you $2. Would you like to give them a try?"</p>
                            </div>
                            <div class="script-note">
                                <strong>Note:</strong> Highlight value, popularity, and special offers. Handle objections with confidence and provide social proof.
                            </div>
                        </div>

                        <div class="script-section">
                            <h3>4. Closing & Confirmation</h3>
                            <div class="script-dialogue">
                                <p class="script-customer">Customer: "Okay, I'll try the wings."</p>
                                <p class="script-agent">Agent: "Great choice! You won't regret it. So I have you down for one large crispy chicken burger meal and a 6-piece order of our spicy wings. Your total comes to $18.99. Will this be for delivery or pickup?"</p>
                            </div>
                            <div class="script-note">
                                <strong>Note:</strong> Always confirm the complete order and provide the total before proceeding to payment/delivery details.
                            </div>
                        </div>

                        <div class="script-section">
                            <h3>5. Final Upsell Opportunity</h3>
                            <div class="script-dialogue">
                                <p class="script-agent">Agent: "Perfect! Just to let you know, if you add our signature chocolate lava cake for $4.99, you'll qualify for free delivery on orders over $20. Would you like to add the cake and save on delivery?"</p>
                                <p class="script-customer">Customer: "That sounds good, add the cake."</p>
                                <p class="script-agent">Agent: "Excellent! Your new total is $23.98 with free delivery. Your order will be ready in approximately 25 minutes. Thank you for choosing Crispy Chicken!"</p>
                            </div>
                            <div class="script-note">
                                <strong>Note:</strong> Use final upsell opportunities to provide additional value to the customer, such as free delivery or special combo deals.
                            </div>
                        </div>

                        <div class="script-section">
                            <h3>Key Upselling Principles</h3>
                            <ul>
                                <li><strong>Listen Actively:</strong> Pay attention to customer preferences and needs</li>
                                <li><strong>Be Genuine:</strong> Recommend items you truly believe in</li>
                                <li><strong>Focus on Value:</strong> Explain benefits, not just features</li>
                                <li><strong>Timing is Key:</strong> Introduce upsells at natural conversation points</li>
                                <li><strong>Handle Objections:</strong> Acknowledge concerns and provide solutions</li>
                                <li><strong>Know Your Products:</strong> Be prepared to answer questions about menu items</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Upload View -->
                <div id="view-upload" class="view">
                    <div class="upload-section">
                        <h3>Upload Agent Performance Data</h3>
                        <p style="margin-bottom: 20px; color: var(--text-muted);">
                            Upload Excel/CSV file with agent performance data. The system will automatically calculate all metrics.
                        </p>
                        
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p><strong>Click to upload or drag and drop</strong></p>
                            <p>Excel (.xlsx, .xls) or CSV files only</p>
                            <p style="font-size: 0.8rem; margin-top: 10px;">Maximum file size: 10MB</p>
                        </div>
                        
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="AgentDashboard.handleFileUpload(event)">
                        
                        <div style="margin-top: 30px;">
                            <h4>File Format Requirements:</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 0.85rem;">
                                <p><strong>Required columns:</strong> Agent, Total_Rings, Answered, Missed, Avg_Wait, Max_Wait, Avg_Talk, Total_Talk, Orders, Sales, Target, Upsell_Attempts, Upsell_Success</p>
                                <p><strong>Time format:</strong> HH:MM:SS or MM:SS</p>
                                <p><strong>Example row:</strong> "201 – Nirjala,3061,656,2405,0:08,3:32,1:28,16:09:29,125,12500,15000,45,12"</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="AgentDashboard.downloadTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <button class="btn btn-info" onclick="AgentDashboard.loadSampleData()">
                                <i class="fas fa-magic"></i> Load Sample Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics View -->
                <div id="view-analytics" class="view">
                    <div class="card">
                        <h3>Performance Analytics</h3>
                        <div class="chart-container">
                            <canvas id="analyticsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Performance Insights</h3>
                        <div id="insightsContainer">
                            <!-- Insights will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- History View -->
                <div id="view-history" class="view">
                    <div class="card">
                        <h3>Report History</h3>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Period</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- Data loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="view-settings" class="view">
                    <div class="card">
                        <h3>Dashboard Settings</h3>
                        <div class="form-group">
                            <label for="autoSaveInterval">Auto-save Interval (seconds)</label>
                            <input type="number" id="autoSaveInterval" class="form-control" value="5" min="1" max="60">
                        </div>
                        <div class="form-group">
                            <label for="defaultPeriod">Default Period</label>
                            <select id="defaultPeriod" class="form-control">
                                <option value="21-days">21 Days</option>
                                <option value="monthly">Monthly</option>
                                <option value="custom">Custom Range</option>
                                <option value="all">All Data</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="AgentDashboard.saveSettings()">Save Settings</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <h3>Upload Excel File</h3>
            <div style="margin-bottom: 20px;">
                <p>Select Excel or CSV file with agent performance data:</p>
                <input type="file" id="modalFileInput" accept=".csv,.xlsx,.xls" class="form-control" style="margin-bottom: 15px;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="AgentDashboard.processUploadedFile()">
                        <i class="fas fa-upload"></i> Upload & Process
                    </button>
                    <button class="btn btn-secondary" onclick="AgentDashboard.closeModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Agent Performance Dashboard
        const AgentDashboard = {
            // Data Storage
            agents: [],
            currentPeriod: '21-days',
            versionStatus: 'draft',
            isDirty: false,
            chart: null,
            analyticsChart: null,
            upsellChart: null,
            autoSaveTimer: null,

            // Initialize
            init: function() {
                this.loadFromStorage();
                this.loadSettings();
                this.setupEventListeners();
                this.renderAgentTable();
                this.renderUpsellTable();
                this.updateKPIs();
                this.renderCharts();
                this.updateVersionInfo();
                this.renderHistory();
            },

            // Setup Event Listeners
            setupEventListeners: function() {
                // Auto-save on changes
                this.autoSaveTimer = setInterval(() => {
                    if (this.isDirty) {
                        this.saveToStorage();
                        this.isDirty = false;
                    }
                }, 5000);

                // Drag and drop for upload
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.style.borderColor = 'var(--primary)';
                        uploadArea.style.background = '#f0f8ff';
                    });

                    uploadArea.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        uploadArea.style.borderColor = 'var(--border)';
                        uploadArea.style.background = 'white';
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.style.borderColor = 'var(--border)';
                        uploadArea.style.background = 'white';
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            this.handleFileUpload({ target: { files: files } });
                        }
                    });
                }
            },

            // View Management
            switchView: function(view) {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.classList.add('active');

                // Update view
                document.querySelectorAll('.view').forEach(v => {
                    v.classList.remove('active');
                });
                document.getElementById(`view-${view}`).classList.add('active');

                // Update page title
                const titles = {
                    performance: { title: 'Agent Performance Dashboard', subtitle: 'Real-time performance tracking with editable metrics' },
                    upsell: { title: 'Upsell Tracking', subtitle: 'Monitor and analyze upselling performance' },
                    training: { title: 'Training Scripts', subtitle: 'Access training materials and scripts' },
                    upload: { title: 'Upload Data', subtitle: 'Import Excel/CSV files with agent performance data' },
                    analytics: { title: 'Analytics', subtitle: 'Performance insights and trend analysis' },
                    history: { title: 'History', subtitle: 'Previous performance reports and versions' },
                    settings: { title: 'Settings', subtitle: 'Configure dashboard settings and preferences' }
                };

                document.getElementById('pageTitle').textContent = titles[view]?.title || 'Agent Performance Dashboard';
                document.getElementById('pageSubtitle').textContent = titles[view]?.subtitle || '';

                // Render specific view
                if (view === 'analytics') {
                    this.renderAnalytics();
                } else if (view === 'upsell') {
                    this.renderUpsellChart();
                } else if (view === 'history') {
                    this.renderHistory();
                }
            },

            // Load Sample Data (Initial Data)
            loadSampleData: function() {
                this.agents = [
                    {
                        id: 1,
                        agentId: '201',
                        name: 'Nirjala',
                        totalRings: 3061,
                        answered: 656,
                        missed: 2405,
                        avgWait: '0:08',
                        maxWait: '3:32',
                        avgTalk: '1:28',
                        totalTalk: '16:09:29',
                        orders: 125,
                        sales: 12500,
                        target: 15000,
                        upsellAttempts: 180,
                        upsellSuccess: 45,
                        upsellRevenue: 1350,
                        period: '21-days'
                    },
                    {
                        id: 2,
                        agentId: '202',
                        name: 'Saleh Emad',
                        totalRings: 559,
                        answered: 144,
                        missed: 415,
                        avgWait: '0:04',
                        maxWait: '0:42',
                        avgTalk: '1:32',
                        totalTalk: '3:40:48',
                        orders: 78,
                        sales: 8900,
                        target: 10000,
                        upsellAttempts: 95,
                        upsellSuccess: 20,
                        upsellRevenue: 680,
                        period: '21-days'
                    },
                    {
                        id: 3,
                        agentId: '203',
                        name: 'Nona Rose',
                        totalRings: 2072,
                        answered: 1017,
                        missed: 1055,
                        avgWait: '0:07',
                        maxWait: '7:49',
                        avgTalk: '1:44',
                        totalTalk: '29:39:10',
                        orders: 156,
                        sales: 18200,
                        target: 18000,
                        upsellAttempts: 220,
                        upsellSuccess: 65,
                        upsellRevenue: 1950,
                        period: '21-days'
                    },
                    {
                        id: 4,
                        agentId: '204',
                        name: 'Manju Ranabhat',
                        totalRings: 2788,
                        answered: 1220,
                        missed: 1568,
                        avgWait: '0:07',
                        maxWait: '2:25',
                        avgTalk: '1:28',
                        totalTalk: '29:53:16',
                        orders: 143,
                        sales: 15400,
                        target: 16000,
                        upsellAttempts: 190,
                        upsellSuccess: 48,
                        upsellRevenue: 1420,
                        period: '21-days'
                    },
                    {
                        id: 5,
                        agentId: '205',
                        name: 'Melvin Compendio',
                        totalRings: 2246,
                        answered: 1113,
                        missed: 1133,
                        avgWait: '0:05',
                        maxWait: '2:29',
                        avgTalk: '1:56',
                        totalTalk: '36:07:10',
                        orders: 189,
                        sales: 22100,
                        target: 20000,
                        upsellAttempts: 285,
                        upsellSuccess: 120,
                        upsellRevenue: 2450,
                        period: '21-days'
                    },
                    {
                        id: 6,
                        agentId: '206',
                        name: 'Jasmine',
                        totalRings: 1638,
                        answered: 448,
                        missed: 1190,
                        avgWait: '0:07',
                        maxWait: '2:46',
                        avgTalk: '2:26',
                        totalTalk: '18:15:31',
                        orders: 92,
                        sales: 9800,
                        target: 12000,
                        upsellAttempts: 110,
                        upsellSuccess: 25,
                        upsellRevenue: 600,
                        period: '21-days'
                    },
                    {
                        id: 7,
                        agentId: '207',
                        name: 'Asmita',
                        totalRings: 2847,
                        answered: 1333,
                        missed: 1514,
                        avgWait: '0:07',
                        maxWait: '2:00',
                        avgTalk: '1:27',
                        totalTalk: '32:19:58',
                        orders: 167,
                        sales: 19300,
                        target: 19000,
                        upsellAttempts: 240,
                        upsellSuccess: 72,
                        upsellRevenue: 1800,
                        period: '21-days'
                    }
                ];

                this.renderAgentTable();
                this.renderUpsellTable();
                this.updateKPIs();
                this.renderCharts();
                this.showToast('Sample data loaded successfully!');
            },

            // Add New Agent
            addNewAgent: function() {
                const name = document.getElementById('newAgentName').value.trim();
                const orders = parseInt(document.getElementById('newAgentOrders').value) || 0;
                const sales = parseFloat(document.getElementById('newAgentSales').value) || 0;
                const target = parseFloat(document.getElementById('newAgentTarget').value) || 0;
                const upsellAttempts = parseInt(document.getElementById('newAgentUpsellAttempts').value) || 0;
                const upsellSuccess = parseInt(document.getElementById('newAgentUpsellSuccess').value) || 0;

                if (!name) {
                    this.showToast('Please enter agent name', 'error');
                    return;
                }

                // Generate new agent ID
                const maxId = Math.max(...this.agents.map(a => parseInt(a.agentId)), 200);
                const newAgentId = (maxId + 1).toString();

                // Calculate upsell revenue (average of $30 per successful upsell)
                const upsellRevenue = upsellSuccess * 30;

                // Create new agent
                const newAgent = {
                    id: this.agents.length + 1,
                    agentId: newAgentId,
                    name: name,
                    totalRings: 0,
                    answered: 0,
                    missed: 0,
                    avgWait: '0:00',
                    maxWait: '0:00',
                    avgTalk: '0:00',
                    totalTalk: '0:00:00',
                    orders: orders,
                    sales: sales,
                    target: target,
                    upsellAttempts: upsellAttempts,
                    upsellSuccess: upsellSuccess,
                    upsellRevenue: upsellRevenue,
                    period: this.currentPeriod
                };

                // Add to agents array
                this.agents.push(newAgent);

                // Clear form
                document.getElementById('newAgentName').value = '';
                document.getElementById('newAgentOrders').value = '';
                document.getElementById('newAgentSales').value = '';
                document.getElementById('newAgentTarget').value = '';
                document.getElementById('newAgentUpsellAttempts').value = '';
                document.getElementById('newAgentUpsellSuccess').value = '';

                // Update UI
                this.renderAgentTable();
                this.renderUpsellTable();
                this.updateKPIs();
                this.renderCharts();
                
                // Save to storage
                this.saveToStorage();
                
                this.showToast(`Agent ${name} added successfully!`, 'success');
            },

            // Delete Agent
            deleteAgent: function(agentId) {
                if (confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                    const agentIndex = this.agents.findIndex(a => a.id === agentId);
                    if (agentIndex !== -1) {
                        const agentName = this.agents[agentIndex].name;
                        this.agents.splice(agentIndex, 1);
                        
                        // Update UI
                        this.renderAgentTable();
                        this.renderUpsellTable();
                        this.updateKPIs();
                        this.renderCharts();
                        
                        // Save to storage
                        this.saveToStorage();
                        
                        this.showToast(`Agent ${agentName} deleted successfully!`, 'success');
                    }
                }
            },

            // Calculate Answer Rate
            calculateAnswerRate: function(agent) {
                if (agent.totalRings > 0) {
                    return ((agent.answered / agent.totalRings) * 100).toFixed(2);
                }
                return 0;
            },

            // Calculate Achievement Percentage
            calculateAchievement: function(agent) {
                if (agent.target > 0) {
                    return ((agent.sales / agent.target) * 100).toFixed(2);
                }
                return 0;
            },

            // Calculate Upsell Rate
            calculateUpsellRate: function(agent) {
                if (agent.upsellAttempts > 0) {
                    return ((agent.upsellSuccess / agent.upsellAttempts) * 100).toFixed(2);
                }
                return 0;
            },

            // Calculate Average Upsell Value
            calculateAvgUpsellValue: function(agent) {
                if (agent.upsellSuccess > 0) {
                    return (agent.upsellRevenue / agent.upsellSuccess).toFixed(2);
                }
                return 0;
            },

            // Get Performance Level
            getPerformanceLevel: function(answerRate) {
                if (answerRate >= 45) return 'high';
                if (answerRate >= 35) return 'medium';
                return 'low';
            },

            // Get Achievement Level
            getAchievementLevel: function(achievement) {
                if (achievement >= 100) return 'high';
                if (achievement >= 80) return 'medium';
                return 'low';
            },

            // Get Upsell Level
            getUpsellLevel: function(upsellRate) {
                if (upsellRate >= 35) return 'high';
                if (upsellRate >= 25) return 'medium';
                return 'low';
            },

            // Parse Time to Seconds
            parseTimeToSeconds: function(timeStr) {
                if (!timeStr) return 0;
                
                const parts = timeStr.split(':').map(Number);
                
                if (parts.length === 1) {
                    // Just seconds
                    return parts[0] || 0;
                } else if (parts.length === 2) {
                    // Minutes:Seconds
                    return (parts[0] * 60) + (parts[1] || 0);
                } else if (parts.length === 3) {
                    // Hours:Minutes:Seconds
                    return (parts[0] * 3600) + (parts[1] * 60) + (parts[2] || 0);
                }
                
                return 0;
            },

            // Seconds to Time String
            secondsToTimeString: function(seconds) {
                if (!seconds || seconds <= 0) return '0:00';
                
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }
            },

            // Render Agent Table
            renderAgentTable: function() {
                const tbody = document.getElementById('agentTableBody');
                const filteredAgents = this.agents.filter(agent => 
                    this.currentPeriod === 'all' || agent.period === this.currentPeriod
                );

                tbody.innerHTML = filteredAgents.map(agent => {
                    const answerRate = this.calculateAnswerRate(agent);
                    const performanceLevel = this.getPerformanceLevel(answerRate);
                    const achievement = this.calculateAchievement(agent);
                    const achievementLevel = this.getAchievementLevel(achievement);
                    
                    let rateClass = 'rate-low';
                    if (answerRate >= 45) rateClass = 'rate-high';
                    else if (answerRate >= 35) rateClass = 'rate-medium';

                    let perfIcon = 'performance-low';
                    if (performanceLevel === 'high') perfIcon = 'performance-high';
                    else if (performanceLevel === 'medium') perfIcon = 'performance-medium';

                    let achievementClass = 'achievement-low';
                    if (achievement >= 100) achievementClass = 'achievement-high';
                    else if (achievement >= 80) achievementClass = 'achievement-medium';

                    return `
                        <tr data-agent-id="${agent.id}">
                            <td><strong>${agent.agentId} – ${agent.name}</strong></td>
                            <td class="editable-cell" data-field="totalRings" contenteditable="true">${agent.totalRings.toLocaleString()}</td>
                            <td class="editable-cell" data-field="answered" contenteditable="true">${agent.answered.toLocaleString()}</td>
                            <td class="editable-cell" data-field="missed" contenteditable="true">${agent.missed.toLocaleString()}</td>
                            <td class="editable-cell" data-field="avgWait" contenteditable="true">${agent.avgWait}</td>
                            <td class="editable-cell" data-field="maxWait" contenteditable="true">${agent.maxWait}</td>
                            <td class="editable-cell" data-field="avgTalk" contenteditable="true">${agent.avgTalk}</td>
                            <td class="editable-cell" data-field="totalTalk" contenteditable="true">${agent.totalTalk}</td>
                            <td class="editable-cell" data-field="orders" contenteditable="true">${agent.orders.toLocaleString()}</td>
                            <td class="editable-cell" data-field="sales" contenteditable="true">$${agent.sales.toLocaleString()}</td>
                            <td class="editable-cell" data-field="target" contenteditable="true">$${agent.target.toLocaleString()}</td>
                            <td>
                                <span class="achievement-badge ${achievementClass}" id="achievement-${agent.id}">
                                    ${achievement}%
                                </span>
                            </td>
                            <td>
                                <span class="answer-rate-badge ${rateClass}" id="rate-${agent.id}">
                                    ${answerRate}%
                                </span>
                            </td>
                            <td>
                                <span class="performance-indicator ${perfIcon}"></span>
                                ${performanceLevel.charAt(0).toUpperCase() + performanceLevel.slice(1)}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="AgentDashboard.deleteAgent(${agent.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add event listeners to editable cells
                this.setupEditableCells();
            },

            // Render Upsell Table
            renderUpsellTable: function() {
                const tbody = document.getElementById('upsellTableBody');
                const filteredAgents = this.agents.filter(agent => 
                    this.currentPeriod === 'all' || agent.period === this.currentPeriod
                );

                tbody.innerHTML = filteredAgents.map(agent => {
                    const upsellRate = this.calculateUpsellRate(agent);
                    const upsellLevel = this.getUpsellLevel(upsellRate);
                    const avgUpsellValue = this.calculateAvgUpsellValue(agent);
                    
                    let upsellClass = 'rate-low';
                    if (upsellRate >= 35) upsellClass = 'rate-high';
                    else if (upsellRate >= 25) upsellClass = 'rate-medium';

                    let upsellIcon = 'performance-low';
                    if (upsellLevel === 'high') upsellIcon = 'performance-high';
                    else if (upsellLevel === 'medium') upsellIcon = 'performance-medium';

                    return `
                        <tr data-agent-id="${agent.id}">
                            <td><strong>${agent.agentId} – ${agent.name}</strong></td>
                            <td>${agent.upsellAttempts.toLocaleString()}</td>
                            <td>${agent.upsellSuccess.toLocaleString()}</td>
                            <td>
                                <span class="answer-rate-badge ${upsellClass}">
                                    ${upsellRate}%
                                </span>
                            </td>
                            <td>$${agent.upsellRevenue.toLocaleString()}</td>
                            <td>$${avgUpsellValue}</td>
                            <td>
                                <span class="performance-indicator ${upsellIcon}"></span>
                                ${upsellLevel.charAt(0).toUpperCase() + upsellLevel.slice(1)}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="AgentDashboard.deleteAgent(${agent.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            // Setup Editable Cells
            setupEditableCells: function() {
                const editableCells = document.querySelectorAll('.editable-cell');
                
                editableCells.forEach(cell => {
                    // Remove existing listeners
                    cell.removeEventListener('focus', this.handleCellFocus);
                    cell.removeEventListener('blur', this.handleCellBlur);
                    cell.removeEventListener('keydown', this.handleCellKeydown);
                    
                    // Add new listeners
                    cell.addEventListener('focus', this.handleCellFocus.bind(this));
                    cell.addEventListener('blur', this.handleCellBlur.bind(this));
                    cell.addEventListener('keydown', this.handleCellKeydown.bind(this));
                });
            },

            // Handle Cell Focus
            handleCellFocus: function(e) {
                e.target.classList.add('editing');
                e.target.dataset.originalValue = e.target.textContent;
            },

            // Handle Cell Blur
            handleCellBlur: function(e) {
                e.target.classList.remove('editing');
                this.updateAgentData(e.target);
            },

            // Handle Cell Keydown
            handleCellKeydown: function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                } else if (e.key === 'Escape') {
                    e.target.textContent = e.target.dataset.originalValue;
                    e.target.blur();
                }
            },

            // Update Agent Data
            updateAgentData: function(cell) {
                const row = cell.closest('tr');
                const agentId = parseInt(row.dataset.agentId);
                const field = cell.dataset.field;
                let value = cell.textContent.trim();

                // Find agent
                const agent = this.agents.find(a => a.id === agentId);
                if (!agent) return;

                // Parse value based on field type
                if (field === 'totalRings' || field === 'answered' || field === 'missed' || field === 'orders') {
                    value = parseInt(value.replace(/,/g, '')) || 0;
                    
                    // Auto-calculate missed if needed
                    if (field === 'totalRings' || field === 'answered') {
                        agent.missed = Math.max(0, agent.totalRings - agent.answered);
                    }
                } else if (field === 'sales' || field === 'target') {
                    value = parseFloat(value.replace(/[$,]/g, '')) || 0;
                }

                // Update agent data
                agent[field] = value;
                
                // Mark as dirty
                this.isDirty = true;

                // Update answer rate and performance
                this.updateAgentPerformance(agentId);

                // Update KPIs
                this.updateKPIs();

                // Update charts
                this.renderCharts();

                // Show toast
                this.showToast(`${agent.name}'s ${field} updated`);
            },

            // Update Agent Performance
            updateAgentPerformance: function(agentId) {
                const agent = this.agents.find(a => a.id === agentId);
                if (!agent) return;

                const answerRate = this.calculateAnswerRate(agent);
                const performanceLevel = this.getPerformanceLevel(answerRate);
                const achievement = this.calculateAchievement(agent);
                const achievementLevel = this.getAchievementLevel(achievement);
                
                let rateClass = 'rate-low';
                if (answerRate >= 45) rateClass = 'rate-high';
                else if (answerRate >= 35) rateClass = 'rate-medium';

                let perfIcon = 'performance-low';
                if (performanceLevel === 'high') perfIcon = 'performance-high';
                else if (performanceLevel === 'medium') perfIcon = 'performance-medium';

                let achievementClass = 'achievement-low';
                if (achievement >= 100) achievementClass = 'achievement-high';
                else if (achievement >= 80) achievementClass = 'achievement-medium';

                // Update answer rate cell
                const rateCell = document.getElementById(`rate-${agentId}`);
                if (rateCell) {
                    rateCell.textContent = `${answerRate}%`;
                    rateCell.className = `answer-rate-badge ${rateClass}`;
                }

                // Update achievement cell
                const achievementCell = document.getElementById(`achievement-${agentId}`);
                if (achievementCell) {
                    achievementCell.textContent = `${achievement}%`;
                    achievementCell.className = `achievement-badge ${achievementClass}`;
                }

                // Update performance cell
                const row = document.querySelector(`tr[data-agent-id="${agentId}"]`);
                if (row) {
                    const perfCell = row.querySelector('td:nth-child(14)');
                    if (perfCell) {
                        perfCell.innerHTML = `
                            <span class="performance-indicator ${perfIcon}"></span>
                            ${performanceLevel.charAt(0).toUpperCase() + performanceLevel.slice(1)}
                        `;
                    }
                }
            },

            // Update KPIs
            updateKPIs: function() {
                const filteredAgents = this.agents.filter(agent => 
                    this.currentPeriod === 'all' || agent.period === this.currentPeriod
                );

                if (filteredAgents.length === 0) return;

                // Calculate totals
                const totalCalls = filteredAgents.reduce((sum, agent) => sum + agent.totalRings, 0);
                const totalAnswered = filteredAgents.reduce((sum, agent) => sum + agent.answered, 0);
                const totalSales = filteredAgents.reduce((sum, agent) => sum + agent.sales, 0);
                const totalUpsellRevenue = filteredAgents.reduce((sum, agent) => sum + agent.upsellRevenue, 0);
                const totalUpsellAttempts = filteredAgents.reduce((sum, agent) => sum + agent.upsellAttempts, 0);
                const totalUpsellSuccess = filteredAgents.reduce((sum, agent) => sum + agent.upsellSuccess, 0);
                
                // Calculate average answer rate
                const avgAnswerRate = totalCalls > 0 ? ((totalAnswered / totalCalls) * 100).toFixed(1) : 0;
                const avgUpsellRate = totalUpsellAttempts > 0 ? ((totalUpsellSuccess / totalUpsellAttempts) * 100).toFixed(1) : 0;

                // Find top performers
                let topAgent = filteredAgents[0];
                let topRate = this.calculateAnswerRate(topAgent);
                
                let topUpseller = filteredAgents[0];
                let topUpsellRate = this.calculateUpsellRate(topUpseller);
                
                filteredAgents.forEach(agent => {
                    const rate = this.calculateAnswerRate(agent);
                    if (rate > topRate) {
                        topAgent = agent;
                        topRate = rate;
                    }
                    
                    const upsellRate = this.calculateUpsellRate(agent);
                    if (upsellRate > topUpsellRate) {
                        topUpseller = agent;
                        topUpsellRate = upsellRate;
                    }
                });

                // Calculate average wait time (convert to seconds, average, then back to MM:SS)
                const totalWaitSeconds = filteredAgents.reduce((sum, agent) => {
                    const [min, sec] = agent.avgWait.split(':').map(Number);
                    return sum + (min * 60) + (sec || 0);
                }, 0);
                
                const avgWaitSeconds = Math.round(totalWaitSeconds / filteredAgents.length);
                const avgWaitFormatted = `${Math.floor(avgWaitSeconds / 60)}:${(avgWaitSeconds % 60).toString().padStart(2, '0')}`;

                // Update KPI cards
                document.getElementById('kpi-total-calls').textContent = totalCalls.toLocaleString();
                document.getElementById('kpi-answer-rate').textContent = `${avgAnswerRate}%`;
                document.getElementById('kpi-total-sales').textContent = `$${totalSales.toLocaleString()}`;
                document.getElementById('kpi-top-agent').textContent = topAgent.name.split(' ')[0];
                
                // Update Upsell KPIs
                document.getElementById('kpi-upsell-revenue').textContent = `$${totalUpsellRevenue.toLocaleString()}`;
                document.getElementById('kpi-upsell-rate').textContent = `${avgUpsellRate}%`;
                document.getElementById('kpi-upsell-attempts').textContent = totalUpsellAttempts.toLocaleString();
                document.getElementById('kpi-upsell-top-agent').textContent = topUpseller.name.split(' ')[0];
                document.getElementById('kpi-top-upseller').textContent = topUpseller.name.split(' ')[0];
            },

            // Render Charts
            renderCharts: function() {
                const ctx = document.getElementById('performanceChart');
                if (!ctx) {
                    console.warn('Performance chart canvas not found');
                    return;
                }

                const filteredAgents = this.agents.filter(agent => 
                    this.currentPeriod === 'all' || agent.period === this.currentPeriod
                );

                // Destroy existing chart
                if (this.chart) {
                    this.chart.destroy();
                }

                // Prepare data
                const labels = filteredAgents.map(agent => agent.name);
                const answerRates = filteredAgents.map(agent => parseFloat(this.calculateAnswerRate(agent)));
                const achievements = filteredAgents.map(agent => parseFloat(this.calculateAchievement(agent)));
                const sales = filteredAgents.map(agent => agent.sales);

                // Create chart
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Answer Rate (%)',
                                data: answerRates,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                yAxisID: 'y',
                                type: 'line',
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Achievement (%)',
                                data: achievements,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y',
                                type: 'line',
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Sales ($)',
                                data: sales,
                                backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Percentage (%)'
                                },
                                min: 0,
                                max: 100
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Sales ($)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            },

            // Render Upsell Chart
            renderUpsellChart: function() {
                const ctx = document.getElementById('upsellChart');
                if (!ctx) {
                    console.warn('Upsell chart canvas not found');
                    return;
                }

                const filteredAgents = this.agents.filter(agent => 
                    this.currentPeriod === 'all' || agent.period === this.currentPeriod
                );

                // Destroy existing chart
                if (this.upsellChart) {
                    this.upsellChart.destroy();
                }

                // Prepare data
                const labels = filteredAgents.map(agent => agent.name);
                const upsellRates = filteredAgents.map(agent => parseFloat(this.calculateUpsellRate(agent)));
                const upsellRevenue = filteredAgents.map(agent => agent.upsellRevenue);

                // Create chart
                this.upsellChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Upsell Success Rate (%)',
                                data: upsellRates,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y',
                                type: 'line',
                                fill: false,
                                tension: 0.4
                            },
                            {
                                label: 'Upsell Revenue ($)',
                                data: upsellRevenue,
                                backgroundColor: 'rgba(153, 102, 255, 0.7)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Success Rate (%)'
                                },
                                min: 0,
                                max: 100
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Revenue ($)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            },

            // Render Analytics
            renderAnalytics: function() {
                const ctx = document.getElementById('analyticsChart');
                if (!ctx) {
                    console.warn('Analytics chart canvas not found');
                    return;
                }

                // Destroy existing chart
                if (this.analyticsChart) {
                    this.analyticsChart.destroy();
                }

                // Prepare data for analytics
                const performanceLevels = {
                    high: this.agents.filter(agent => this.getPerformanceLevel(this.calculateAnswerRate(agent)) === 'high').length,
                    medium: this.agents.filter(agent => this.getPerformanceLevel(this.calculateAnswerRate(agent)) === 'medium').length,
                    low: this.agents.filter(agent => this.getPerformanceLevel(this.calculateAnswerRate(agent)) === 'low').length
                };

                const achievementLevels = {
                    high: this.agents.filter(agent => this.getAchievementLevel(this.calculateAchievement(agent)) === 'high').length,
                    medium: this.agents.filter(agent => this.getAchievementLevel(this.calculateAchievement(agent)) === 'medium').length,
                    low: this.agents.filter(agent => this.getAchievementLevel(this.calculateAchievement(agent)) === 'low').length
                };

                // Create analytics chart
                this.analyticsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['High Performance', 'Medium Performance', 'Low Performance'],
                        datasets: [
                            {
                                label: 'Answer Rate',
                                data: [performanceLevels.high, performanceLevels.medium, performanceLevels.low],
                                backgroundColor: [
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(255, 99, 132, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(255, 99, 132, 1)'
                                ],
                                borderWidth: 1
                            },
                            {
                                label: 'Achievement',
                                data: [achievementLevels.high, achievementLevels.medium, achievementLevels.low],
                                backgroundColor: [
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(153, 102, 255, 0.7)',
                                    'rgba(255, 159, 64, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} agents (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Generate insights
                this.generateInsights();
            },

            // Generate Insights
            generateInsights: function() {
                const container = document.getElementById('insightsContainer');
                const filteredAgents = this.agents.filter(agent => 
                    this.currentPeriod === 'all' || agent.period === this.currentPeriod
                );

                if (filteredAgents.length === 0) {
                    container.innerHTML = '<p>No data available for insights.</p>';
                    return;
                }

                // Calculate insights
                const totalCalls = filteredAgents.reduce((sum, agent) => sum + agent.totalRings, 0);
                const totalAnswered = filteredAgents.reduce((sum, agent) => sum + agent.answered, 0);
                const totalSales = filteredAgents.reduce((sum, agent) => sum + agent.sales, 0);
                const totalTarget = filteredAgents.reduce((sum, agent) => sum + agent.target, 0);
                const totalUpsellRevenue = filteredAgents.reduce((sum, agent) => sum + agent.upsellRevenue, 0);
                
                const overallAnswerRate = totalCalls > 0 ? ((totalAnswered / totalCalls) * 100).toFixed(1) : 0;
                const overallAchievement = totalTarget > 0 ? ((totalSales / totalTarget) * 100).toFixed(1) : 0;

                // Find top and bottom performers
                let topPerformer = filteredAgents[0];
                let bottomPerformer = filteredAgents[0];
                let topRate = this.calculateAnswerRate(topPerformer);
                let bottomRate = this.calculateAnswerRate(bottomPerformer);

                let topSalesAgent = filteredAgents[0];
                let topAchievement = this.calculateAchievement(topSalesAgent);

                let topUpseller = filteredAgents[0];
                let topUpsellRate = this.calculateUpsellRate(topUpseller);

                filteredAgents.forEach(agent => {
                    const rate = this.calculateAnswerRate(agent);
                    if (rate > topRate) {
                        topPerformer = agent;
                        topRate = rate;
                    }
                    if (rate < bottomRate) {
                        bottomPerformer = agent;
                        bottomRate = rate;
                    }
                    
                    const achievement = this.calculateAchievement(agent);
                    if (achievement > topAchievement) {
                        topSalesAgent = agent;
                        topAchievement = achievement;
                    }
                    
                    const upsellRate = this.calculateUpsellRate(agent);
                    if (upsellRate > topUpsellRate) {
                        topUpseller = agent;
                        topUpsellRate = upsellRate;
                    }
                });

                // Generate insights HTML
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 6px;">
                            <h4 style="color: #2e7d32; margin-bottom: 10px;"><i class="fas fa-trophy"></i> Top Performer</h4>
                            <p><strong>${topPerformer.name}</strong> has the highest answer rate at <strong>${topRate}%</strong></p>
                            <p>Answered ${topPerformer.answered.toLocaleString()} of ${topPerformer.totalRings.toLocaleString()} calls</p>
                        </div>
                        
                        <div style="background: #fff3e0; padding: 15px; border-radius: 6px;">
                            <h4 style="color: #ef6c00; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Needs Attention</h4>
                            <p><strong>${bottomPerformer.name}</strong> has the lowest answer rate at <strong>${bottomRate}%</strong></p>
                            <p>Missed ${bottomPerformer.missed.toLocaleString()} calls (${((bottomPerformer.missed/bottomPerformer.totalRings)*100).toFixed(1)}% missed rate)</p>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 6px;">
                            <h4 style="color: #1565c0; margin-bottom: 10px;"><i class="fas fa-dollar-sign"></i> Sales Champion</h4>
                            <p><strong>${topSalesAgent.name}</strong> achieved <strong>${topAchievement}%</strong> of target</p>
                            <p>Sales: $${topSalesAgent.sales.toLocaleString()} of $${topSalesAgent.target.toLocaleString()} target</p>
                        </div>
                        
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 6px;">
                            <h4 style="color: #7b1fa2; margin-bottom: 10px;"><i class="fas fa-hand-holding-usd"></i> Upsell Master</h4>
                            <p><strong>${topUpseller.name}</strong> has the highest upsell rate at <strong>${topUpsellRate}%</strong></p>
                            <p>Generated $${topUpseller.upsellRevenue.toLocaleString()} in upsell revenue</p>
                        </div>
                        
                        <div style="background: #e0f2f1; padding: 15px; border-radius: 6px;">
                            <h4 style="color: #00695c; margin-bottom: 10px;"><i class="fas fa-chart-line"></i> Overall Performance</h4>
                            <p>Overall answer rate: <strong>${overallAnswerRate}%</strong></p>
                            <p>Overall achievement: <strong>${overallAchievement}%</strong></p>
                            <p>Total upsell revenue: <strong>$${totalUpsellRevenue.toLocaleString()}</strong></p>
                        </div>
                    </div>
                `;
            },

            // Period Management
            setPeriod: function(period) {
                this.currentPeriod = period;
                
                // Update period selector
                document.querySelectorAll('.period-option').forEach(option => {
                    option.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Update period info
                const periodText = {
                    '21-days': '21 Days - Jan 2026',
                    'monthly': 'Monthly - Jan 2026',
                    'custom': 'Custom Range - Select dates',
                    'all': 'All Data - Complete History'
                };
                
                document.getElementById('periodInfo').textContent = `Period: ${periodText[period]}`;
                
                // Refresh data
                this.renderAgentTable();
                this.renderUpsellTable();
                this.updateKPIs();
                this.renderCharts();
            },

            // File Upload Handling
            handleFileUpload: function(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showLoading(true);

                // Check file type
                const fileName = file.name.toLowerCase();
                if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                    this.showToast('Please upload only CSV or Excel files', 'error');
                    this.showLoading(false);
                    return;
                }

                // Process file
                this.processExcelFile(file);
            },

            // Process Excel File
            processExcelFile: function(file) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        this.processUploadedData(jsonData);
                    } catch (error) {
                        console.error('Error reading file:', error);
                        this.showToast('Error reading file. Please check the format.', 'error');
                        this.showLoading(false);
                    }
                };
                
                reader.readAsArrayBuffer(file);
            },

            // Process Uploaded Data
            processUploadedData: function(data) {
                try {
                    // Skip header row
                    const rows = data.slice(1);
                    
                    rows.forEach((row, index) => {
                        if (row.length >= 13) {
                            const agentStr = row[0]?.toString() || '';
                            const agentMatch = agentStr.match(/(\d+)\s*–\s*(.+)/);
                            
                            if (agentMatch) {
                                const agentCode = agentMatch[1];
                                const agentName = agentMatch[2].trim();
                                
                                // Find or create agent
                                let agent = this.agents.find(a => a.agentId === agentCode);
                                if (!agent) {
                                    agent = {
                                        id: this.agents.length + 1,
                                        agentId: agentCode,
                                        name: agentName,
                                        period: this.currentPeriod
                                    };
                                    this.agents.push(agent);
                                }
                                
                                // Update agent data
                                agent.totalRings = parseInt(row[1]) || 0;
                                agent.answered = parseInt(row[2]) || 0;
                                agent.missed = parseInt(row[3]) || 0;
                                agent.avgWait = row[4]?.toString() || '0:00';
                                agent.maxWait = row[5]?.toString() || '0:00';
                                agent.avgTalk = row[6]?.toString() || '0:00';
                                agent.totalTalk = row[7]?.toString() || '0:00:00';
                                agent.orders = parseInt(row[8]) || 0;
                                agent.sales = parseFloat(row[9]) || 0;
                                agent.target = parseFloat(row[10]) || 0;
                                agent.upsellAttempts = parseInt(row[11]) || 0;
                                agent.upsellSuccess = parseInt(row[12]) || 0;
                                
                                // Calculate derived values
                                agent.upsellRevenue = agent.upsellSuccess * 30; // Average of $30 per successful upsell
                            }
                        }
                    });
                    
                    this.saveToStorage();
                    this.renderAgentTable();
                    this.renderUpsellTable();
                    this.updateKPIs();
                    this.renderCharts();
                    this.showLoading(false);
                    this.showToast(`Successfully uploaded ${rows.length} records!`, 'success');
                    
                } catch (error) {
                    console.error('Error processing data:', error);
                    this.showLoading(false);
                    this.showToast('Error processing file data. Please check the format.', 'error');
                }
            },

            // Download Template
            downloadTemplate: function() {
                const templateData = [
                    ['Agent', 'Total_Rings', 'Answered', 'Missed', 'Avg_Wait', 'Max_Wait', 'Avg_Talk', 'Total_Talk', 'Orders', 'Sales', 'Target', 'Upsell_Attempts', 'Upsell_Success'],
                    ['201 – Nirjala', '3061', '656', '2405', '0:08', '3:32', '1:28', '16:09:29', '125', '12500', '15000', '180', '45'],
                    ['202 – Saleh Emad', '559', '144', '415', '0:04', '0:42', '1:32', '3:40:48', '78', '8900', '10000', '95', '20'],
                    ['203 – Nona Rose', '2072', '1017', '1055', '0:07', '7:49', '1:44', '29:39:10', '156', '18200', '18000', '220', '65']
                ];

                let csvContent = templateData.map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'agent_performance_template.csv';
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('Template downloaded successfully!');
            },

            // Finalize Report
            finalizeReport: function() {
                this.versionStatus = 'final';
                this.updateVersionInfo();
                
                // Add to history
                try {
                    const history = JSON.parse(localStorage.getItem('reportHistory')) || [];
                    history.push({
                        id: 'report_' + Date.now(),
                        date: new Date().toISOString(),
                        period: this.currentPeriod,
                        status: 'final',
                        data: this.agents
                    });
                    localStorage.setItem('reportHistory', JSON.stringify(history));
                } catch (error) {
                    console.error('Error saving to history:', error);
                }
                
                this.saveToStorage();
                this.showToast('Report finalized! Changes are now locked.', 'success');
            },

            // Update Version Info
            updateVersionInfo: function() {
                const statusElement = document.getElementById('versionStatus');
                const infoElement = document.getElementById('versionInfo');
                
                if (this.versionStatus === 'draft') {
                    statusElement.textContent = 'DRAFT';
                    statusElement.className = 'version-badge version-draft';
                    infoElement.textContent = `Last edited by Admin • ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                } else {
                    statusElement.textContent = 'FINAL';
                    statusElement.className = 'version-badge version-final';
                    infoElement.textContent = `Finalized by Admin • ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }
            },

            // Save Changes
            saveChanges: function() {
                this.saveToStorage();
                this.showToast('All changes saved successfully!', 'success');
                this.isDirty = false;
            },

            // Reset Changes
            resetChanges: function() {
                if (confirm('Are you sure you want to reset all changes? This cannot be undone.')) {
                    this.loadFromStorage();
                    this.renderAgentTable();
                    this.renderUpsellTable();
                    this.updateKPIs();
                    this.renderCharts();
                    this.showToast('All changes have been reset.', 'info');
                }
            },

            // Open Upload Modal
            openUploadModal: function() {
                document.getElementById('uploadModal').style.display = 'flex';
            },

            // Close Modal
            closeModal: function() {
                document.getElementById('uploadModal').style.display = 'none';
            },

            // Process Uploaded File from Modal
            processUploadedFile: function() {
                const fileInput = document.getElementById('modalFileInput');
                if (fileInput.files.length > 0) {
                    this.handleFileUpload({ target: fileInput });
                    this.closeModal();
                } else {
                    this.showToast('Please select a file first', 'error');
                }
            },

            // Show Loading
            showLoading: function(show) {
                const loading = document.getElementById('loading');
                if (show) {
                    loading.classList.add('active');
                } else {
                    loading.classList.remove('active');
                }
            },

            // Show Toast
            showToast: function(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast';
                
                if (type === 'error') {
                    toast.style.background = '#d32f2f';
                } else if (type === 'info') {
                    toast.style.background = '#1976d2';
                } else {
                    toast.style.background = '#388e3c';
                }
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            },

            // Storage Management
            saveToStorage: function() {
                try {
                    localStorage.setItem('agentPerformanceData', JSON.stringify({
                        agents: this.agents,
                        currentPeriod: this.currentPeriod,
                        versionStatus: this.versionStatus,
                        lastUpdated: new Date().toISOString()
                    }));
                    console.log('Data saved to storage');
                } catch (e) {
                    console.error('Error saving data:', e);
                    this.showToast('Error saving data: ' + e.message, 'error');
                }
            },

            loadFromStorage: function() {
                try {
                    const saved = localStorage.getItem('agentPerformanceData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.agents = data.agents || [];
                        this.currentPeriod = data.currentPeriod || '21-days';
                        this.versionStatus = data.versionStatus || 'draft';
                    } else {
                        // Load sample data if no saved data
                        this.loadSampleData();
                    }
                } catch (e) {
                    console.error('Error loading data:', e);
                    this.showToast('Error loading data: ' + e.message, 'error');
                    this.loadSampleData();
                }
            },

            // Settings Management
            saveSettings: function() {
                const autoSaveInterval = document.getElementById('autoSaveInterval').value;
                const defaultPeriod = document.getElementById('defaultPeriod').value;
                
                // Save settings to localStorage
                localStorage.setItem('dashboardSettings', JSON.stringify({
                    autoSaveInterval: autoSaveInterval,
                    defaultPeriod: defaultPeriod
                }));
                
                // Update auto-save interval
                if (this.autoSaveTimer) {
                    clearInterval(this.autoSaveTimer);
                }
                
                this.autoSaveTimer = setInterval(() => {
                    if (this.isDirty) {
                        this.saveToStorage();
                        this.isDirty = false;
                    }
                }, autoSaveInterval * 1000);
                
                this.showToast('Settings saved successfully!');
            },

            loadSettings: function() {
                try {
                    const settings = JSON.parse(localStorage.getItem('dashboardSettings'));
                    if (settings) {
                        document.getElementById('autoSaveInterval').value = settings.autoSaveInterval || 5;
                        document.getElementById('defaultPeriod').value = settings.defaultPeriod || '21-days';
                        
                        // Update auto-save interval
                        if (this.autoSaveTimer) {
                            clearInterval(this.autoSaveTimer);
                        }
                        
                        this.autoSaveTimer = setInterval(() => {
                            if (this.isDirty) {
                                this.saveToStorage();
                                this.isDirty = false;
                            }
                        }, settings.autoSaveInterval * 1000 || 5000);
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            },

            // Render History
            renderHistory: function() {
                const tbody = document.getElementById('historyTableBody');
                if (!tbody) return;
                
                // Load history from localStorage
                try {
                    const history = JSON.parse(localStorage.getItem('reportHistory')) || [];
                    
                    if (history.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" style="padding: 40px; text-align: center; color: var(--text-muted);">
                                    No report history available
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tbody.innerHTML = history.map(report => `
                        <tr>
                            <td>${new Date(report.date).toLocaleDateString()}</td>
                            <td>${report.period}</td>
                            <td>
                                <span class="version-badge version-${report.status}">
                                    ${report.status.toUpperCase()}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="AgentDashboard.viewReport('${report.id}')">
                                    View
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } catch (error) {
                    console.error('Error loading history:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="padding: 40px; text-align: center; color: var(--text-muted);">
                                Error loading report history
                            </td>
                        </tr>
                    `;
                }
            },

            // View Report
            viewReport: function(reportId) {
                // In a full implementation, this would load and display the specific report
                this.showToast(`Viewing report ${reportId}`);
            }
        };

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            AgentDashboard.init();
        });
    </script>
</body>
</html>
