<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRISPY | Agent Performance Dashboard</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #D32F2F;
            --primary-dark: #b71c1c;
            --primary-light: #ffcdd2;
            --secondary: #FFC107;
            --success: #388E3C;
            --success-light: #c8e6c9;
            --warning: #F57C00;
            --warning-light: #ffe0b2;
            --danger: #D32F2F;
            --danger-light: #ffcdd2;
            --info: #1976D2;
            --dark: #212121;
            --light: #f8f9fa;
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --border: #e0e0e0;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', Helvetica, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            flex-shrink: 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .brand {
            padding: 20px;
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            font-weight: 800;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .brand::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1));
            transform: translate(30px, -30px);
        }

        .brand i {
            margin-right: 10px;
            font-size: 1.4rem;
        }

        .brand span {
            color: var(--secondary);
        }

        .nav-menu {
            flex: 1;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            overflow-y: auto;
        }

        .nav-item {
            padding: 12px 15px;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(211, 47, 47, 0.2), rgba(211, 47, 47, 0.1));
            color: white;
            font-weight: 600;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: var(--bg-panel);
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .page-header p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--bg-panel);
            color: var(--text-main);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .view-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .view {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Styles */
        .card {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--bg-panel);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .kpi-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .kpi-change.positive {
            color: var(--success);
        }

        .kpi-change.negative {
            color: var(--danger);
        }

        /* Table Styles */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 1200px;
        }

        th {
            background: #f8f9fa;
            color: var(--text-muted);
            font-weight: 700;
            text-align: center;
            padding: 14px 12px;
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            text-align: center;
            vertical-align: middle;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* Editable Cells */
        .editable-cell {
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            padding: 8px;
            border-radius: 4px;
        }

        .editable-cell:hover {
            background-color: #f0f8ff;
            border: 1px solid #cce7ff;
        }

        .editable-cell.editing {
            background-color: #fff;
            border: 2px solid var(--info);
        }

        .editable-cell input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: inherit;
            font-family: inherit;
            padding: 4px;
        }

        .editable-cell input:focus {
            outline: none;
        }

        /* Performance Indicators */
        .performance-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .performance-high {
            background-color: var(--success);
        }

        .performance-medium {
            background-color: var(--warning);
        }

        .performance-low {
            background-color: var(--danger);
        }

        .rate-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
            min-width: 70px;
        }

        .rate-high {
            background: var(--success-light);
            color: var(--success);
        }

        .rate-medium {
            background: var(--warning-light);
            color: var(--warning);
        }

        .rate-low {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: var(--dark);
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            z-index: 2000;
            transform: translateY(100px);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .toast.show {
            transform: translateY(0);
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: var(--bg-panel);
            color: var(--text-main);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        /* Period Selector */
        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .period-option {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .period-option:hover {
            background: #f8f9fa;
        }

        .period-option.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f9f9f9;
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-draft {
            background: var(--warning-light);
            color: var(--warning);
        }

        .status-final {
            background: var(--success-light);
            color: var(--success);
        }

        /* Loading */
        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100vh;
                z-index: 1000;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .period-selector {
                flex-wrap: wrap;
            }
            
            .controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <i class="fas fa-chart-network"></i>
                <span>CRISPY AGENTS</span>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="AgentSystem.switchView('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </div>
                <div class="nav-item" onclick="AgentSystem.switchView('performance')">
                    <i class="fas fa-chart-line"></i>
                    Performance
                </div>
                <div class="nav-item" onclick="AgentSystem.switchView('upload')">
                    <i class="fas fa-upload"></i>
                    Upload Data
                </div>
                <div class="nav-item" onclick="AgentSystem.switchView('analytics')">
                    <i class="fas fa-chart-pie"></i>
                    Analytics
                </div>
                <div class="nav-item" onclick="AgentSystem.switchView('history')">
                    <i class="fas fa-history"></i>
                    History
                </div>
                <div class="nav-item" onclick="AgentSystem.switchView('settings')">
                    <i class="fas fa-cog"></i>
                    Settings
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-header">
                    <h1 id="pageTitle">Agent Performance Dashboard</h1>
                    <p id="pageSubtitle">Real-time performance tracking with editable metrics</p>
                </div>
                <div class="controls">
                    <div class="date-range-container">
                        <input type="text" id="dateRange" class="form-control" style="width: 200px;" placeholder="Select date range">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="AgentSystem.downloadTemplate()">
                            <i class="fas fa-download"></i> Template
                        </button>
                        <button class="btn btn-primary" onclick="AgentSystem.openUploadModal()">
                            <i class="fas fa-upload"></i> Upload Excel
                        </button>
                        <button class="btn btn-success" onclick="AgentSystem.finalizeReport()">
                            <i class="fas fa-check-circle"></i> Finalize
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <!-- View Container -->
            <div class="view-container">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view active">
                    <!-- Status Bar -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Report Status</h3>
                            <div>
                                <span class="status-badge status-draft" id="reportStatus">DRAFT</span>
                                <span class="text-muted" id="reportInfo" style="margin-left: 10px; font-size: 0.85rem;">
                                    Last edited: Just now â€¢ Period: 21 Days - Jan 2026
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Period Selector -->
                    <div class="period-selector">
                        <div class="period-option active" onclick="AgentSystem.setPeriod('21-days')">21 Days</div>
                        <div class="period-option" onclick="AgentSystem.setPeriod('monthly')">Monthly</div>
                        <div class="period-option" onclick="AgentSystem.setPeriod('weekly')">Weekly</div>
                        <div class="period-option" onclick="AgentSystem.setPeriod('all')">All Data</div>
                    </div>

                    <!-- KPI Summary -->
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-title">Total Calls</div>
                            <div class="kpi-value" id="kpiTotalCalls">15,211</div>
                            <div class="kpi-change positive">
                                <i class="fas fa-arrow-up"></i> 12.5% from last period
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Answer Rate</div>
                            <div class="kpi-value" id="kpiAnswerRate">42.1%</div>
                            <div class="kpi-change positive">
                                <i class="fas fa-arrow-up"></i> 3.2% improvement
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Avg Wait Time</div>
                            <div class="kpi-value" id="kpiAvgWait">0:06</div>
                            <div class="kpi-change positive">
                                <i class="fas fa-arrow-down"></i> 15s reduction
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-title">Top Performer</div>
                            <div class="kpi-value" id="kpiTopAgent">Melvin</div>
                            <div class="kpi-title">49.55% Answer Rate</div>
                        </div>
                    </div>

                    <!-- Performance Chart -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Answer Rate Trend</h3>
                            <select id="chartMetric" class="form-control" style="max-width: 200px;">
                                <option value="answerRate">Answer Rate</option>
                                <option value="calls">Total Calls</option>
                                <option value="waitTime">Wait Time</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <h3 class="card-title" style="margin-bottom: 15px;">Quick Actions</h3>
                        <div class="btn-group" style="flex-wrap: wrap; gap: 10px;">
                            <button class="btn btn-secondary" onclick="AgentSystem.exportReport()">
                                <i class="fas fa-file-export"></i> Export Report
                            </button>
                            <button class="btn btn-secondary" onclick="AgentSystem.sendReport()">
                                <i class="fas fa-paper-plane"></i> Send to Manager
                            </button>
                            <button class="btn btn-secondary" onclick="AgentSystem.printReport()">
                                <i class="fas fa-print"></i> Print Report
                            </button>
                            <button class="btn btn-info" onclick="AgentSystem.generateInsights()">
                                <i class="fas fa-lightbulb"></i> Generate Insights
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Performance View -->
                <div id="view-performance" class="view">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Agent Performance Details</h3>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-secondary" onclick="AgentSystem.resetEdits()">
                                    <i class="fas fa-undo"></i> Reset Changes
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="AgentSystem.saveAllChanges()">
                                    <i class="fas fa-save"></i> Save All
                                </button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="performanceTable">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Total Rings</th>
                                        <th>Answered</th>
                                        <th>Missed</th>
                                        <th>Avg Wait</th>
                                        <th>Max Wait</th>
                                        <th>Avg Talk</th>
                                        <th>Total Talk</th>
                                        <th>Answer Rate</th>
                                        <th>Performance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="performanceTableBody">
                                    <!-- Data loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 15px; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                            <i class="fas fa-info-circle"></i> Click on any number to edit. Changes update calculations automatically.
                        </div>
                    </div>
                </div>

                <!-- Upload View -->
                <div id="view-upload" class="view">
                    <div class="card">
                        <h3 class="card-title">Upload Agent Performance Data</h3>
                        <p style="margin-bottom: 20px; color: var(--text-muted);">
                            Upload Excel/CSV file with agent performance data. System will automatically calculate all metrics.
                        </p>
                        
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p><strong>Click to upload or drag and drop</strong></p>
                            <p>Excel (.xlsx, .xls) or CSV files only</p>
                            <p style="font-size: 0.8rem; margin-top: 10px;">Supports your provided data format</p>
                        </div>
                        
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" 
                               onchange="AgentSystem.handleFileUpload(event)">
                        
                        <div style="margin-top: 30px;">
                            <h4>Data Format Requirements:</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 0.85rem;">
                                <p><strong>Required columns:</strong> Agent, Total Rings, Answered, Missed, Avg Wait, Max Wait, Avg Talk, Total Talk</p>
                                <p><strong>Time format:</strong> HH:MM:SS or MM:SS (0:08, 1:28, 16:09:29)</p>
                                <p><strong>Example:</strong> "201 â€“ Nirjala,3061,656,2405,0:08,3:32,1:28,16:09:29"</p>
                                <p><strong>Automatic calculations:</strong> Answer Rate = Answered / Total Rings</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="AgentSystem.downloadTemplate()">
                                <i class="fas fa-download"></i> Download Template
                            </button>
                            <button class="btn btn-info" onclick="AgentSystem.loadSampleData()">
                                <i class="fas fa-magic"></i> Load Sample Data
                            </button>
                            <button class="btn btn-primary" onclick="AgentSystem.processManualEntry()">
                                <i class="fas fa-keyboard"></i> Manual Entry
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analytics View -->
                <div id="view-analytics" class="view">
                    <div class="card">
                        <h3 class="card-title">Performance Analytics</h3>
                        <div class="chart-container">
                            <canvas id="analyticsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Performance Insights</h3>
                        <div id="insightsContainer">
                            <!-- Insights generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Upload Performance Data</h3>
            <div class="form-group">
                <label class="form-label">Select Period</label>
                <select id="uploadPeriod" class="form-control">
                    <option value="21-days">21 Days</option>
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="custom">Custom Period</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Select File</label>
                <input type="file" id="modalFileInput" class="form-control" accept=".csv,.xlsx,.xls">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="AgentSystem.processUpload()">
                    <i class="fas fa-upload"></i> Upload & Process
                </button>
                <button class="btn btn-secondary" onclick="AgentSystem.closeModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div id="manualEntryModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Manual Data Entry</h3>
            <form id="manualEntryForm">
                <div class="form-group">
                    <label class="form-label">Agent</label>
                    <select id="entryAgent" class="form-control" required>
                        <option value="">Select Agent</option>
                        <option value="201 â€“ Nirjala">201 â€“ Nirjala</option>
                        <option value="202 â€“ Saleh Emad">202 â€“ Saleh Emad</option>
                        <option value="203 â€“ Nona Rose">203 â€“ Nona Rose</option>
                        <option value="204 â€“ Manju Ranabhat">204 â€“ Manju Ranabhat</option>
                        <option value="205 â€“ Melvin Compendio">205 â€“ Melvin Compendio</option>
                        <option value="206 â€“ Jasmine">206 â€“ Jasmine</option>
                        <option value="207 â€“ Asmita">207 â€“ Asmita</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label class="form-label">Total Rings</label>
                        <input type="number" id="entryRings" class="form-control" required min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Answered</label>
                        <input type="number" id="entryAnswered" class="form-control" required min="0">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label class="form-label">Avg Wait (MM:SS)</label>
                        <input type="text" id="entryAvgWait" class="form-control" placeholder="0:08" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Avg Talk (MM:SS)</label>
                        <input type="text" id="entryAvgTalk" class="form-control" placeholder="1:28" required>
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>Calculated Metrics:</strong>
                    <div id="calculatedMetrics" style="margin-top: 10px;">
                        Answer Rate: <span id="calcAnswerRate">0%</span><br>
                        Missed Calls: <span id="calcMissed">0</span><br>
                        Total Talk: <span id="calcTotalTalk">0:00:00</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">Save Entry</button>
                    <button type="button" class="btn btn-secondary" onclick="AgentSystem.closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // ============================================
        // AGENT PERFORMANCE MANAGEMENT SYSTEM
        // ============================================

        const AgentSystem = {
            // Data Storage
            agents: [],
            performanceData: [],
            currentPeriod: '21-days',
            reportStatus: 'draft',
            isDirty: false,
            charts: {},
            editingCell: null,

            // Initialize System
            init: function() {
                console.log('ðŸ”„ Initializing Agent Performance System...');
                this.loadData();
                this.setupEventListeners();
                this.setupDateRangePicker();
                this.renderDashboard();
                this.showToast('System ready! Loaded ' + this.agents.length + ' agents');
            },

            // Load Initial Data
            loadData: function() {
                try {
                    // Try to load from localStorage first
                    const saved = localStorage.getItem('crispyAgentData');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.agents = data.agents || [];
                        this.performanceData = data.performanceData || [];
                        this.reportStatus = data.reportStatus || 'draft';
                        console.log('ðŸ“ Loaded data from storage:', this.agents.length, 'agents');
                    } else {
                        // Load sample data
                        this.loadSampleData();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.loadSampleData();
                }
            },

            // Load Sample Data (Your Provided Data)
            loadSampleData: function() {
                this.agents = [
                    { id: 1, code: '201', name: 'Nirjala', active: true, target: 45 },
                    { id: 2, code: '202', name: 'Saleh Emad', active: true, target: 45 },
                    { id: 3, code: '203', name: 'Nona Rose', active: true, target: 45 },
                    { id: 4, code: '204', name: 'Manju Ranabhat', active: true, target: 45 },
                    { id: 5, code: '205', name: 'Melvin Compendio', active: true, target: 45 },
                    { id: 6, code: '206', name: 'Jasmine', active: true, target: 45 },
                    { id: 7, code: '207', name: 'Asmita', active: true, target: 45 }
                ];

                // Your exact performance data
                this.performanceData = [
                    {
                        agentId: 1,
                        period: '21-days',
                        totalRings: 3061,
                        answered: 656,
                        missed: 2405,
                        avgWait: '0:08',
                        maxWait: '3:32',
                        avgTalk: '1:28',
                        totalTalk: '16:09:29',
                        answerRate: 21.43,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        agentId: 2,
                        period: '21-days',
                        totalRings: 559,
                        answered: 144,
                        missed: 415,
                        avgWait: '0:04',
                        maxWait: '0:42',
                        avgTalk: '1:32',
                        totalTalk: '3:40:48',
                        answerRate: 25.76,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        agentId: 3,
                        period: '21-days',
                        totalRings: 2072,
                        answered: 1017,
                        missed: 1055,
                        avgWait: '0:07',
                        maxWait: '7:49',
                        avgTalk: '1:44',
                        totalTalk: '29:39:10',
                        answerRate: 49.08,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        agentId: 4,
                        period: '21-days',
                        totalRings: 2788,
                        answered: 1220,
                        missed: 1568,
                        avgWait: '0:07',
                        maxWait: '2:25',
                        avgTalk: '1:28',
                        totalTalk: '29:53:16',
                        answerRate: 43.76,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        agentId: 5,
                        period: '21-days',
                        totalRings: 2246,
                        answered: 1113,
                        missed: 1133,
                        avgWait: '0:05',
                        maxWait: '2:29',
                        avgTalk: '1:56',
                        totalTalk: '36:07:10',
                        answerRate: 49.55,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        agentId: 6,
                        period: '21-days',
                        totalRings: 1638,
                        answered: 448,
                        missed: 1190,
                        avgWait: '0:07',
                        maxWait: '2:46',
                        avgTalk: '2:26',
                        totalTalk: '18:15:31',
                        answerRate: 27.35,
                        lastUpdated: new Date().toISOString()
                    },
                    {
                        agentId: 7,
                        period: '21-days',
                        totalRings: 2847,
                        answered: 1333,
                        missed: 1514,
                        avgWait: '0:07',
                        maxWait: '2:00',
                        avgTalk: '1:27',
                        totalTalk: '32:19:58',
                        answerRate: 46.82,
                        lastUpdated: new Date().toISOString()
                    }
                ];

                this.saveData();
                this.showToast('Sample data loaded successfully!');
            },

            // Save Data to Storage
            saveData: function() {
                try {
                    const data = {
                        agents: this.agents,
                        performanceData: this.performanceData,
                        reportStatus: this.reportStatus,
                        lastSaved: new Date().toISOString()
                    };
                    localStorage.setItem('crispyAgentData', JSON.stringify(data));
                    console.log('ðŸ’¾ Data saved to storage');
                    this.isDirty = false;
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.showToast('Error saving data!', 'error');
                }
            },

            // Setup Event Listeners
            setupEventListeners: function() {
                // Auto-save on changes
                setInterval(() => {
                    if (this.isDirty) {
                        this.saveData();
                    }
                }, 10000); // Auto-save every 10 seconds

                // Drag and drop for upload
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'var(--primary)';
                    uploadArea.style.background = '#f0f8ff';
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'var(--border)';
                    uploadArea.style.background = 'white';
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'var(--border)';
                    uploadArea.style.background = 'white';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFileUpload({ target: { files: files } });
                    }
                });

                // Chart metric selector
                document.getElementById('chartMetric')?.addEventListener('change', (e) => {
                    this.updatePerformanceChart();
                });

                // Manual entry form calculations
                ['entryRings', 'entryAnswered', 'entryAvgTalk'].forEach(id => {
                    document.getElementById(id)?.addEventListener('input', () => {
                        this.calculateEntryMetrics();
                    });
                });

                // Manual entry form submit
                document.getElementById('manualEntryForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveManualEntry();
                });
            },

            // Setup Date Range Picker
            setupDateRangePicker: function() {
                $('#dateRange').daterangepicker({
                    opens: 'left',
                    locale: { format: 'YYYY-MM-DD' },
                    ranges: {
                        'Today': [moment(), moment()],
                        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                        'Last 21 Days': [moment().subtract(20, 'days'), moment()],
                        'This Month': [moment().startOf('month'), moment().endOf('month')],
                        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    }
                }, (start, end) => {
                    this.filterByDateRange(start, end);
                });
            },

            // View Management
            switchView: function(view) {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                event?.currentTarget?.classList.add('active');

                // Update view
                document.querySelectorAll('.view').forEach(v => {
                    v.classList.remove('active');
                });
                document.getElementById(`view-${view}`).classList.add('active');

                // Update page title
                const titles = {
                    dashboard: { title: 'Agent Performance Dashboard', subtitle: 'Real-time performance tracking with editable metrics' },
                    performance: { title: 'Performance Details', subtitle: 'Edit and analyze individual agent performance' },
                    upload: { title: 'Upload Data', subtitle: 'Import Excel/CSV files or manual entry' },
                    analytics: { title: 'Analytics & Insights', subtitle: 'Performance analysis and recommendations' },
                    history: { title: 'History & Reports', subtitle: 'Historical data and report archives' },
                    settings: { title: 'Settings', subtitle: 'System configuration and preferences' }
                };

                document.getElementById('pageTitle').textContent = titles[view]?.title || 'Agent Performance Dashboard';
                document.getElementById('pageSubtitle').textContent = titles[view]?.subtitle || '';

                // Render specific view
                if (view === 'dashboard') {
                    this.renderDashboard();
                } else if (view === 'performance') {
                    this.renderPerformanceTable();
                } else if (view === 'analytics') {
                    this.renderAnalytics();
                }
            },

            // Render Dashboard
            renderDashboard: function() {
                this.updateKPIs();
                this.updatePerformanceChart();
                this.updateReportStatus();
            },

            // Update KPIs
            updateKPIs: function() {
                const filteredData = this.getFilteredData();
                
                if (filteredData.length === 0) {
                    console.warn('No data available for KPIs');
                    return;
                }

                // Calculate totals
                const totalCalls = filteredData.reduce((sum, d) => sum + d.totalRings, 0);
                const totalAnswered = filteredData.reduce((sum, d) => sum + d.answered, 0);
                const avgAnswerRate = totalCalls > 0 ? ((totalAnswered / totalCalls) * 100).toFixed(1) : 0;

                // Find top performer
                let topAgent = filteredData[0];
                filteredData.forEach(data => {
                    if (data.answerRate > topAgent.answerRate) {
                        topAgent = data;
                    }
                });

                // Calculate average wait time
                const totalWaitSeconds = filteredData.reduce((sum, d) => {
                    const [min, sec] = d.avgWait.split(':').map(Number);
                    return sum + (min * 60) + (sec || 0);
                }, 0);
                
                const avgWaitSeconds = Math.round(totalWaitSeconds / filteredData.length);
                const avgWaitFormatted = `${Math.floor(avgWaitSeconds / 60)}:${(avgWaitSeconds % 60).toString().padStart(2, '0')}`;

                // Update KPI cards
                document.getElementById('kpiTotalCalls').textContent = totalCalls.toLocaleString();
                document.getElementById('kpiAnswerRate').textContent = `${avgAnswerRate}%`;
                document.getElementById('kpiAvgWait').textContent = avgWaitFormatted;
                
                const agent = this.agents.find(a => a.id === topAgent.agentId);
                document.getElementById('kpiTopAgent').textContent = agent?.name || 'Unknown';
            },

            // Update Performance Chart
            updatePerformanceChart: function() {
                const ctx = document.getElementById('performanceChart');
                if (!ctx) return;

                const filteredData = this.getFilteredData();
                const metric = document.getElementById('chartMetric')?.value || 'answerRate';

                // Destroy existing chart
                if (this.charts.performance) {
                    this.charts.performance.destroy();
                }

                // Prepare data
                const labels = filteredData.map(data => {
                    const agent = this.agents.find(a => a.id === data.agentId);
                    return `${agent?.code} - ${agent?.name}`;
                });

                const dataset = filteredData.map(data => {
                    switch(metric) {
                        case 'answerRate': return data.answerRate;
                        case 'calls': return data.totalRings;
                        case 'waitTime': 
                            const [min, sec] = data.avgWait.split(':').map(Number);
                            return (min * 60) + (sec || 0);
                        default: return data.answerRate;
                    }
                });

                const colors = this.generateColors(dataset.length);
                const yAxisLabel = {
                    answerRate: 'Answer Rate (%)',
                    calls: 'Number of Calls',
                    waitTime: 'Wait Time (seconds)'
                }[metric];

                // Create chart
                this.charts.performance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: yAxisLabel,
                            data: dataset,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: yAxisLabel
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let value = context.raw;
                                        if (metric === 'answerRate') {
                                            return `${value}% answer rate`;
                                        } else if (metric === 'waitTime') {
                                            const min = Math.floor(value / 60);
                                            const sec = value % 60;
                                            return `${min}:${sec.toString().padStart(2, '0')} average wait`;
                                        }
                                        return `${value.toLocaleString()} calls`;
                                    }
                                }
                            }
                        }
                    }
                });
            },

            // Render Performance Table
            renderPerformanceTable: function() {
                const tbody = document.getElementById('performanceTableBody');
                const filteredData = this.getFilteredData();

                if (filteredData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" style="padding: 40px; text-align: center; color: var(--text-muted);">
                                <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                No performance data available for this period
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = filteredData.map(data => {
                    const agent = this.agents.find(a => a.id === data.agentId);
                    if (!agent) return '';

                    const answerRate = data.answerRate;
                    let rateClass = 'rate-low';
                    if (answerRate >= 45) rateClass = 'rate-high';
                    else if (answerRate >= 35) rateClass = 'rate-medium';

                    let perfIcon = 'performance-low';
                    if (answerRate >= 45) perfIcon = 'performance-high';
                    else if (answerRate >= 35) perfIcon = 'performance-medium';

                    return `
                        <tr data-agent-id="${data.agentId}">
                            <td><strong>${agent.code} â€“ ${agent.name}</strong></td>
                            <td>
                                <div class="editable-cell" 
                                     data-field="totalRings" 
                                     data-agent-id="${data.agentId}"
                                     onclick="AgentSystem.startEdit(this)">
                                    ${data.totalRings.toLocaleString()}
                                </div>
                            </td>
                            <td>
                                <div class="editable-cell" 
                                     data-field="answered" 
                                     data-agent-id="${data.agentId}"
                                     onclick="AgentSystem.startEdit(this)">
                                    ${data.answered.toLocaleString()}
                                </div>
                            </td>
                            <td>
                                <div class="editable-cell" 
                                     data-field="missed" 
                                     data-agent-id="${data.agentId}"
                                     onclick="AgentSystem.startEdit(this)">
                                    ${data.missed.toLocaleString()}
                                </div>
                            </td>
                            <td>
                                <div class="editable-cell" 
                                     data-field="avgWait" 
                                     data-agent-id="${data.agentId}"
                                     onclick="AgentSystem.startEdit(this)">
                                    ${data.avgWait}
                                </div>
                            </td>
                            <td>
                                <div class="editable-cell" 
                                     data-field="maxWait" 
                                     data-agent-id="${data.agentId}"
                                     onclick="AgentSystem.startEdit(this)">
                                    ${data.maxWait}
                                </div>
                            </td>
                            <td>
                                <div class="editable-cell" 
                                     data-field="avgTalk" 
                                     data-agent-id="${data.agentId}"
                                     onclick="AgentSystem.startEdit(this)">
                                    ${data.avgTalk}
                                </div>
                            </td>
                            <td>
                                <div class="editable-cell" 
                                     data-field="totalTalk" 
                                     data-agent-id="${data.agentId}"
                                     onclick="AgentSystem.startEdit(this)">
                                    ${data.totalTalk}
                                </div>
                            </td>
                            <td>
                                <span class="rate-badge ${rateClass}" id="rate-${data.agentId}">
                                    ${answerRate.toFixed(2)}%
                                </span>
                            </td>
                            <td>
                                <span class="performance-indicator ${perfIcon}"></span>
                                ${this.getPerformanceLevel(answerRate)}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary" 
                                        onclick="AgentSystem.editAgent(${data.agentId})"
                                        style="padding: 4px 8px; font-size: 0.75rem;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            // Start Editing a Cell
            startEdit: function(cell) {
                if (this.editingCell) {
                    this.finishEdit(this.editingCell);
                }

                this.editingCell = cell;
                cell.classList.add('editing');
                
                const currentValue = cell.textContent.trim();
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.style.width = '100%';
                input.style.textAlign = 'center';
                input.style.border = 'none';
                input.style.background = 'transparent';
                input.style.fontSize = 'inherit';
                input.style.fontFamily = 'inherit';
                
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();
                
                // Handle input events
                input.addEventListener('blur', () => this.finishEdit(cell));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.finishEdit(cell);
                    } else if (e.key === 'Escape') {
                        cell.innerHTML = currentValue;
                        cell.classList.remove('editing');
                        this.editingCell = null;
                    }
                });
            },

            // Finish Editing a Cell
            finishEdit: function(cell) {
                if (!cell.classList.contains('editing')) return;

                const input = cell.querySelector('input');
                const newValue = input.value.trim();
                const field = cell.dataset.field;
                const agentId = parseInt(cell.dataset.agentId);

                // Find the performance data
                const dataIndex = this.performanceData.findIndex(d => 
                    d.agentId === agentId && d.period === this.currentPeriod
                );

                if (dataIndex === -1) {
                    console.error('Performance data not found for agent:', agentId);
                    return;
                }

                const data = this.performanceData[dataIndex];
                const oldValue = data[field];

                // Validate and convert based on field type
                let processedValue = newValue;
                if (field === 'totalRings' || field === 'answered' || field === 'missed') {
                    processedValue = parseInt(newValue.replace(/,/g, '')) || 0;
                }

                // Update the data
                data[field] = processedValue;
                data.lastUpdated = new Date().toISOString();

                // Recalculate derived fields
                this.recalculateAgentMetrics(agentId);

                // Update the display
                this.updateCellDisplay(cell, field, data);

                cell.classList.remove('editing');
                this.editingCell = null;
                this.isDirty = true;

                // Update KPIs and chart
                this.updateKPIs();
                this.updatePerformanceChart();
                
                this.showToast(`${field} updated for agent ${agentId}`);
            },

            // Recalculate Agent Metrics
            recalculateAgentMetrics: function(agentId) {
                const dataIndex = this.performanceData.findIndex(d => 
                    d.agentId === agentId && d.period === this.currentPeriod
                );

                if (dataIndex === -1) return;

                const data = this.performanceData[dataIndex];

                // Calculate missed calls
                data.missed = Math.max(0, data.totalRings - data.answered);

                // Calculate answer rate
                data.answerRate = data.totalRings > 0 ? 
                    ((data.answered / data.totalRings) * 100) : 0;

                // Update display
                this.updateAgentDisplay(agentId);
            },

            // Update Cell Display
            updateCellDisplay: function(cell, field, data) {
                let displayValue = data[field];
                
                if (field === 'totalRings' || field === 'answered' || field === 'missed') {
                    displayValue = displayValue.toLocaleString();
                }
                
                cell.innerHTML = displayValue;
            },

            // Update Agent Display
            updateAgentDisplay: function(agentId) {
                const data = this.performanceData.find(d => 
                    d.agentId === agentId && d.period === this.currentPeriod
                );

                if (!data) return;

                const answerRate = data.answerRate;
                let rateClass = 'rate-low';
                if (answerRate >= 45) rateClass = 'rate-high';
                else if (answerRate >= 35) rateClass = 'rate-medium';

                // Update answer rate badge
                const rateBadge = document.getElementById(`rate-${agentId}`);
                if (rateBadge) {
                    rateBadge.textContent = `${answerRate.toFixed(2)}%`;
                    rateBadge.className = `rate-badge ${rateClass}`;
                }

                // Update performance level
                const row = document.querySelector(`tr[data-agent-id="${agentId}"]`);
                if (row) {
                    const perfCell = row.querySelector('td:nth-child(10)');
                    if (perfCell) {
                        let perfIcon = 'performance-low';
                        if (answerRate >= 45) perfIcon = 'performance-high';
                        else if (answerRate >= 35) perfIcon = 'performance-medium';

                        perfCell.innerHTML = `
                            <span class="performance-indicator ${perfIcon}"></span>
                            ${this.getPerformanceLevel(answerRate)}
                        `;
                    }
                }
            },

            // Get Performance Level
            getPerformanceLevel: function(rate) {
                if (rate >= 45) return 'High';
                if (rate >= 35) return 'Medium';
                return 'Low';
            },

            // Get Filtered Data
            getFilteredData: function() {
                return this.performanceData.filter(d => 
                    this.currentPeriod === 'all' || d.period === this.currentPeriod
                );
            },

            // Set Period
            setPeriod: function(period) {
                this.currentPeriod = period;
                
                // Update period selector
                document.querySelectorAll('.period-option').forEach(option => {
                    option.classList.remove('active');
                });
                event?.currentTarget?.classList.add('active');
                
                // Update dashboard
                this.renderDashboard();
                this.renderPerformanceTable();
                
                this.showToast(`Viewing data for: ${period.replace('-', ' ')}`);
            },

            // File Upload Handling
            handleFileUpload: function(event) {
                const file = event.target.files[0];
                if (!file) return;

                this.showLoading(true);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        this.processUploadedData(jsonData);
                    } catch (error) {
                        console.error('Error reading file:', error);
                        this.showToast('Error reading file. Please check the format.', 'error');
                        this.showLoading(false);
                    }
                };
                
                reader.readAsArrayBuffer(file);
            },

            // Process Uploaded Data
            processUploadedData: function(data) {
                try {
                    // Skip header row
                    const rows = data.slice(1);
                    
                    rows.forEach((row, index) => {
                        if (row.length >= 8) {
                            const agentStr = row[0]?.toString() || '';
                            const agentMatch = agentStr.match(/(\d+)\s*â€“\s*(.+)/);
                            
                            if (agentMatch) {
                                const agentCode = agentMatch[1];
                                const agentName = agentMatch[2].trim();
                                
                                // Find or create agent
                                let agent = this.agents.find(a => a.code === agentCode);
                                if (!agent) {
                                    agent = {
                                        id: this.agents.length + 1,
                                        code: agentCode,
                                        name: agentName,
                                        active: true,
                                        target: 45
                                    };
                                    this.agents.push(agent);
                                }
                                
                                // Parse performance data
                                const performanceData = {
                                    agentId: agent.id,
                                    period: this.currentPeriod,
                                    totalRings: parseInt(row[1]) || 0,
                                    answered: parseInt(row[2]) || 0,
                                    missed: parseInt(row[3]) || 0,
                                    avgWait: row[4]?.toString() || '0:00',
                                    maxWait: row[5]?.toString() || '0:00',
                                    avgTalk: row[6]?.toString() || '0:00',
                                    totalTalk: row[7]?.toString() || '0:00:00',
                                    answerRate: 0, // Will be calculated
                                    lastUpdated: new Date().toISOString()
                                };
                                
                                // Calculate answer rate
                                performanceData.answerRate = performanceData.totalRings > 0 ? 
                                    ((performanceData.answered / performanceData.totalRings) * 100) : 0;
                                
                                // Update or add performance data
                                const existingIndex = this.performanceData.findIndex(d => 
                                    d.agentId === agent.id && d.period === this.currentPeriod
                                );
                                
                                if (existingIndex >= 0) {
                                    this.performanceData[existingIndex] = performanceData;
                                } else {
                                    this.performanceData.push(performanceData);
                                }
                            }
                        }
                    });
                    
                    this.saveData();
                    this.renderDashboard();
                    this.renderPerformanceTable();
                    this.showLoading(false);
                    this.showToast(`Successfully uploaded ${rows.length} records!`, 'success');
                    
                } catch (error) {
                    console.error('Error processing data:', error);
                    this.showLoading(false);
                    this.showToast('Error processing file data. Please check the format.', 'error');
                }
            },

            // Download Template
            downloadTemplate: function() {
                const templateData = [
                    ['Agent', 'Total Rings', 'Answered', 'Missed', 'Avg Wait', 'Max Wait', 'Avg Talk', 'Total Talk'],
                    ['201 â€“ Nirjala', '3061', '656', '2405', '0:08', '3:32', '1:28', '16:09:29'],
                    ['202 â€“ Saleh Emad', '559', '144', '415', '0:04', '0:42', '1:32', '3:40:48'],
                    ['203 â€“ Nona Rose', '2072', '1017', '1055', '0:07', '7:49', '1:44', '29:39:10']
                ];
                
                const worksheet = XLSX.utils.aoa_to_sheet(templateData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Template');
                
                XLSX.writeFile(workbook, 'agent_performance_template.xlsx');
                this.showToast('Template downloaded successfully!');
            },

            // Open Upload Modal
            openUploadModal: function() {
                document.getElementById('uploadModal').classList.add('show');
            },

            // Process Upload
            processUpload: function() {
                const fileInput = document.getElementById('modalFileInput');
                const periodSelect = document.getElementById('uploadPeriod');
                
                if (!fileInput.files.length) {
                    this.showToast('Please select a file first', 'error');
                    return;
                }
                
                this.currentPeriod = periodSelect.value;
                this.handleFileUpload({ target: fileInput });
                this.closeModal();
            },

            // Manual Entry
            processManualEntry: function() {
                document.getElementById('manualEntryModal').classList.add('show');
            },

            // Calculate Entry Metrics
            calculateEntryMetrics: function() {
                const rings = parseInt(document.getElementById('entryRings').value) || 0;
                const answered = parseInt(document.getElementById('entryAnswered').value) || 0;
                const avgTalk = document.getElementById('entryAvgTalk').value;
                
                // Calculate missed
                const missed = Math.max(0, rings - answered);
                
                // Calculate answer rate
                const answerRate = rings > 0 ? ((answered / rings) * 100).toFixed(2) : 0;
                
                // Calculate total talk time
                let totalTalk = '0:00:00';
                if (avgTalk) {
                    const [min, sec] = avgTalk.split(':').map(Number);
                    const totalSeconds = (min * 60 + (sec || 0)) * answered;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    totalTalk = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Update display
                document.getElementById('calcAnswerRate').textContent = `${answerRate}%`;
                document.getElementById('calcMissed').textContent = missed;
                document.getElementById('calcTotalTalk').textContent = totalTalk;
            },

            // Save Manual Entry
            saveManualEntry: function() {
                const agentStr = document.getElementById('entryAgent').value;
                const rings = parseInt(document.getElementById('entryRings').value);
                const answered = parseInt(document.getElementById('entryAnswered').value);
                const avgWait = document.getElementById('entryAvgWait').value;
                const avgTalk = document.getElementById('entryAvgTalk').value;
                
                if (!agentStr || !rings || !answered || !avgWait || !avgTalk) {
                    this.showToast('Please fill all required fields', 'error');
                    return;
                }
                
                const agentMatch = agentStr.match(/(\d+)\s*â€“\s*(.+)/);
                if (!agentMatch) {
                    this.showToast('Invalid agent format', 'error');
                    return;
                }
                
                const agentCode = agentMatch[1];
                const agentName = agentMatch[2].trim();
                
                // Find or create agent
                let agent = this.agents.find(a => a.code === agentCode);
                if (!agent) {
                    agent = {
                        id: this.agents.length + 1,
                        code: agentCode,
                        name: agentName,
                        active: true,
                        target: 45
                    };
                    this.agents.push(agent);
                }
                
                // Calculate derived values
                const missed = Math.max(0, rings - answered);
                const answerRate = rings > 0 ? ((answered / rings) * 100) : 0;
                
                // Calculate total talk time
                const [min, sec] = avgTalk.split(':').map(Number);
                const totalSeconds = (min * 60 + (sec || 0)) * answered;
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const totalTalk = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Create performance data
                const performanceData = {
                    agentId: agent.id,
                    period: this.currentPeriod,
                    totalRings: rings,
                    answered: answered,
                    missed: missed,
                    avgWait: avgWait,
                    maxWait: avgWait, // Use avg as max for manual entry
                    avgTalk: avgTalk,
                    totalTalk: totalTalk,
                    answerRate: answerRate,
                    lastUpdated: new Date().toISOString()
                };
                
                // Update or add performance data
                const existingIndex = this.performanceData.findIndex(d => 
                    d.agentId === agent.id && d.period === this.currentPeriod
                );
                
                if (existingIndex >= 0) {
                    this.performanceData[existingIndex] = performanceData;
                } else {
                    this.performanceData.push(performanceData);
                }
                
                this.saveData();
                this.renderDashboard();
                this.renderPerformanceTable();
                this.closeModal();
                this.showToast(`Manual entry saved for ${agentName}!`, 'success');
            },

            // Finalize Report
            finalizeReport: function() {
                if (confirm('Are you sure you want to finalize this report? This will lock all data for this period.')) {
                    this.reportStatus = 'final';
                    this.updateReportStatus();
                    this.saveData();
                    this.showToast('Report finalized! Data is now locked for this period.', 'success');
                }
            },

            // Update Report Status
            updateReportStatus: function() {
                const statusElement = document.getElementById('reportStatus');
                const infoElement = document.getElementById('reportInfo');
                
                if (this.reportStatus === 'draft') {
                    statusElement.textContent = 'DRAFT';
                    statusElement.className = 'status-badge status-draft';
                } else {
                    statusElement.textContent = 'FINAL';
                    statusElement.className = 'status-badge status-final';
                }
                
                const periodText = {
                    '21-days': '21 Days - Jan 2026',
                    'monthly': 'Monthly - Jan 2026',
                    'weekly': 'Weekly - Current',
                    'all': 'All Data'
                }[this.currentPeriod] || 'Current Period';
                
                infoElement.textContent = `Last edited: Just now â€¢ Period: ${periodText}`;
            },

            // Reset Edits
            resetEdits: function() {
                if (confirm('Are you sure you want to reset all unsaved changes?')) {
                    this.loadData();
                    this.renderDashboard();
                    this.renderPerformanceTable();
                    this.showToast('All changes reset to last saved state.');
                }
            },

            // Save All Changes
            saveAllChanges: function() {
                this.saveData();
                this.showToast('All changes saved successfully!', 'success');
            },

            // Render Analytics
            renderAnalytics: function() {
                const ctx = document.getElementById('analyticsChart');
                if (!ctx) return;

                const filteredData = this.getFilteredData();
                
                // Destroy existing chart
                if (this.charts.analytics) {
                    this.charts.analytics.destroy();
                }

                // Prepare data for performance distribution
                const performanceLevels = {
                    high: filteredData.filter(d => d.answerRate >= 45).length,
                    medium: filteredData.filter(d => d.answerRate >= 35 && d.answerRate < 45).length,
                    low: filteredData.filter(d => d.answerRate < 35).length
                };

                // Create analytics chart
                this.charts.analytics = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['High Performance (â‰¥45%)', 'Medium Performance (35-44%)', 'Low Performance (<35%)'],
                        datasets: [{
                            data: [performanceLevels.high, performanceLevels.medium, performanceLevels.low],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(255, 99, 132, 0.7)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} agents (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Generate insights
                this.generateInsights();
            },

            // Generate Insights
            generateInsights: function() {
                const filteredData = this.getFilteredData();
                const container = document.getElementById('insightsContainer');

                if (filteredData.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No data available for insights.</p>';
                    return;
                }

                // Calculate insights
                const totalCalls = filteredData.reduce((sum, d) => sum + d.totalRings, 0);
                const totalAnswered = filteredData.reduce((sum, d) => sum + d.answered, 0);
                const overallAnswerRate = totalCalls > 0 ? ((totalAnswered / totalCalls) * 100).toFixed(1) : 0;

                // Find top and bottom performers
                let topPerformer = filteredData[0];
                let bottomPerformer = filteredData[0];
                let topRate = topPerformer.answerRate;
                let bottomRate = bottomPerformer.answerRate;

                filteredData.forEach(data => {
                    if (data.answerRate > topRate) {
                        topPerformer = data;
                        topRate = data.answerRate;
                    }
                    if (data.answerRate < bottomRate) {
                        bottomPerformer = data;
                        bottomRate = data.answerRate;
                    }
                });

                const topAgent = this.agents.find(a => a.id === topPerformer.agentId);
                const bottomAgent = this.agents.find(a => a.id === bottomPerformer.agentId);

                // Generate insights HTML
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 8px;">
                            <h4 style="color: #2e7d32; margin-bottom: 10px;">
                                <i class="fas fa-trophy"></i> Top Performer
                            </h4>
                            <p><strong>${topAgent?.name || 'Unknown'}</strong> has the highest answer rate at <strong>${topRate.toFixed(2)}%</strong></p>
                            <p>Answered ${topPerformer.answered.toLocaleString()} of ${topPerformer.totalRings.toLocaleString()} calls</p>
                            <p style="margin-top: 10px; font-size: 0.85rem;">
                                <i class="fas fa-lightbulb"></i> Best practice: Share their techniques with the team
                            </p>
                        </div>
                        
                        <div style="background: #fff3e0; padding: 20px; border-radius: 8px;">
                            <h4 style="color: #ef6c00; margin-bottom: 10px;">
                                <i class="fas fa-exclamation-triangle"></i> Needs Attention
                            </h4>
                            <p><strong>${bottomAgent?.name || 'Unknown'}</strong> has the lowest answer rate at <strong>${bottomRate.toFixed(2)}%</strong></p>
                            <p>Missed ${bottomPerformer.missed.toLocaleString()} calls (${((bottomPerformer.missed/bottomPerformer.totalRings)*100).toFixed(1)}% missed rate)</p>
                            <p style="margin-top: 10px; font-size: 0.85rem;">
                                <i class="fas fa-lightbulb"></i> Recommendation: Schedule coaching session
                            </p>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 8px;">
                            <h4 style="color: #1565c0; margin-bottom: 10px;">
                                <i class="fas fa-chart-line"></i> Overall Performance
                            </h4>
                            <p>Overall answer rate: <strong>${overallAnswerRate}%</strong></p>
                            <p>Total calls handled: <strong>${totalCalls.toLocaleString()}</strong></p>
                            <p>Successfully answered: <strong>${totalAnswered.toLocaleString()}</strong></p>
                            <p style="margin-top: 10px; font-size: 0.85rem;">
                                <i class="fas fa-lightbulb"></i> Target achievement: ${((overallAnswerRate / 45) * 100).toFixed(1)}%
                            </p>
                        </div>
                    </div>
                `;
            },

            // Export Report
            exportReport: function() {
                const filteredData = this.getFilteredData();
                
                // Create export data
                const exportData = filteredData.map(data => {
                    const agent = this.agents.find(a => a.id === data.agentId);
                    return {
                        Agent: `${agent?.code} â€“ ${agent?.name}`,
                        'Total Rings': data.totalRings,
                        'Answered': data.answered,
                        'Missed': data.missed,
                        'Avg Wait': data.avgWait,
                        'Max Wait': data.maxWait,
                        'Avg Talk': data.avgTalk,
                        'Total Talk': data.totalTalk,
                        'Answer Rate': `${data.answerRate.toFixed(2)}%`
                    };
                });

                // Create worksheet
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Agent Performance');
                
                // Add summary sheet
                const summaryData = [
                    ['Agent Performance Report'],
                    [`Period: ${this.currentPeriod}`],
                    [`Generated: ${new Date().toLocaleString()}`],
                    [''],
                    ['Summary Metrics'],
                    ['Total Calls:', filteredData.reduce((sum, d) => sum + d.totalRings, 0)],
                    ['Total Answered:', filteredData.reduce((sum, d) => sum + d.answered, 0)],
                    ['Overall Answer Rate:', `${((filteredData.reduce((sum, d) => sum + d.answered, 0) / filteredData.reduce((sum, d) => sum + d.totalRings, 0) * 100) || 0).toFixed(2)}%`]
                ];
                
                const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');
                
                // Save file
                XLSX.writeFile(workbook, `agent_performance_${this.currentPeriod}_${new Date().toISOString().split('T')[0]}.xlsx`);
                this.showToast('Report exported successfully!');
            },

            // Send Report
            sendReport: function() {
                this.showToast('Report sending feature would be integrated with email system');
            },

            // Print Report
            printReport: function() {
                window.print();
            },

            // Filter by Date Range
            filterByDateRange: function(start, end) {
                console.log('Filtering by date range:', start.format('YYYY-MM-DD'), 'to', end.format('YYYY-MM-DD'));
                // This would filter data by date range in a real implementation
                this.showToast(`Filtering data from ${start.format('MMM D')} to ${end.format('MMM D')}`);
            },

            // Edit Agent
            editAgent: function(agentId) {
                const agent = this.agents.find(a => a.id === agentId);
                if (agent) {
                    this.showToast(`Editing ${agent.name}'s details`, 'info');
                    // In a full implementation, this would open an agent edit modal
                }
            },

            // Close Modal
            closeModal: function() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('show');
                });
            },

            // Show Loading
            showLoading: function(show) {
                const loading = document.getElementById('loading');
                if (show) {
                    loading.classList.add('active');
                } else {
                    loading.classList.remove('active');
                }
            },

            // Show Toast
            showToast: function(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast';
                
                // Set color based on type
                if (type === 'error') {
                    toast.style.background = '#d32f2f';
                } else if (type === 'info') {
                    toast.style.background = '#1976d2';
                } else if (type === 'warning') {
                    toast.style.background = '#f57c00';
                } else {
                    toast.style.background = '#388e3c';
                }
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            },

            // Generate Colors
            generateColors: function(count) {
                const colors = [];
                for (let i = 0; i < count; i++) {
                    const hue = (i * 137.508) % 360; // Golden angle approximation
                    colors.push(`hsla(${hue}, 70%, 65%, 0.7)`);
                }
                return colors;
            }
        };

        // Initialize the system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            AgentSystem.init();
        });
    </script>
</body>
</html>
